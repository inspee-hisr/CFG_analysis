---
title: "INSPEE Cave Fauna Database Report"
author: "Savvas Paragkamian"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
  word_document:
    toc: yes
    toc_depth: '2'
link-citations: yes
bibliography: packages_used.bib
site: bookdown::bookdown_site
biblio-style: apalike
---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Data manipulation packages
library(readxl)
library(readr)
library(ggplot2)
library(scales)
library(gridExtra)
library(grid)
library(reshape2)
library(dplyr)
library(knitr)
library(tidyr)
library(httr)
library(broom)
library(stringr)

## Data for species

library(rredlist)
library(taxize)
library(rgbif)
library(ISOcodes)
library(spocc)

# Spatial analysis packages

# x <- c("ggmap", "rgdal", "rgeos", "maptools", "tmap","Rcpp","sp")
# #install.packages(x) # warning: uncommenting this may take a number of minutes
# lapply(x, library, character.only = TRUE)
library(RColorBrewer)
library(ggmap)
library(rgdal)
library(rgeos)
library(maptools)
library(tmap)
library(Rcpp)
library(sp)
library(raster) ##Load the Raster Library

packages <- c("readxl","readr","ggplot2","scales","gridExtra","dplyr", "knitr", "tidyr","RColorBrewer","ggmap","rgdal","rgeos","maptools","tmap","Rcpp","sp","raster","broom")

write_bib(x = packages,file = "packages_used.bib")

```

```{r global_options, include=FALSE,echo=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```





# Species Data

```{r,warning=FALSE, message=FALSE, echo=FALSE}

# load the file with species occurences

species_occurencies <- read_xlsx(path = "Cave_Fauna_of_Greece_Census_v5_24_01_2018.xlsx",col_names = T)
species_occurencies[species_occurencies=="NA"] <- NA



# caves <- species_occurencies %>% distinct(Cave_ID,Cave_ID_OLD,CaveName,Cave_Comment,Cave_comment2,CaveReferences,Altitude,Longitude,Latitude,Location_Status,NearestVillage,Municipality,Island,County,Region,NAME,KWD_YPES,Municipalities_gr_original, Municipalities_gr,Municipalities_ISO_843,ID,objectid_NATURA,CODE_NATURA,area_NATURA,perimeter_NATURA,hectares_NATURA,SITETYPE_NATURA,PERIPHERY_NATURA,PREFECTURE_NATURA,NAME_LATIN_NATURA,area_katafygia_agrias_zwhs,FID_katafygia_agrias_zwhs,THESH_katafygia_agrias_zwhs,PERIFEREIA_katafygia_agrias_zwhs,EPOPTEYOYS_katafygia_agrias_zwhs,DHMOS_KOIN_katafygia_agrias_zwhs,NOMOS_katafygia_agrias_zwhs,EKTASH_katafygia_agrias_zwhs,APOFASH_katafygia_agrias_zwhs,FEK_katafygia_agrias_zwhs,EIDH_CHLOR_katafygia_agrias_zwhs,PANIDA_PTH_katafygia_agrias_zwhs,PANIDA_THI_katafygia_agrias_zwhs,PANIDA_PSA_katafygia_agrias_zwhs,PANIDA_ERP_katafygia_agrias_zwhs,PANIDA_AMF_katafygia_agrias_zwhs,area_strem_katafygia_agrias_zwhs,perimeter_katafygia_agrias_zwhs,Cave_References) %>% group_by(Cave_ID) %>% mutate(Cave_References=gsub(";NA","",paste(Cave_References,collapse = ";")), Cave_comment2=paste(Cave_comment2,collapse = ";")) %>% distinct(.) %>% mutate(duplicates=duplicated(Cave_ID,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Cave_ID,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE")))
# 
# caves_dupl <- caves %>% filter(duplicatesAll=="TRUE") %>% group_by(Cave_ID) %>% mutate(Cave_ID_OLD2=paste(Cave_ID_OLD,collapse=";")) %>% filter(Cave_ID==Cave_ID_OLD)
# 
# caves_dupl2 <- caves_dupl %>% dplyr::select(Cave_ID,Cave_ID_OLD2)
# 
# caves_dupl22 <- strsplit(x = caves_dupl2$Cave_ID_OLD2,split = ";")
# caves_dupl22_df <- data_frame(Cave_ID_OLD2=unlist(caves_dupl22), Cave_ID=rep.int(caves_dupl2$Cave_ID,times = sapply(caves_dupl22,length)))
# 
# caves_dupl22_df2 <- caves_dupl22_df %>% left_join(caves_dupl,by=c("Cave_ID"="Cave_ID")) %>% dplyr::select(-c(Cave_ID_OLD2.y,Cave_ID_OLD))
# 
# colnames(caves_dupl22_df2)[1] <- "Cave_ID_OLD"
# 
# caves_filter <- caves %>% filter(duplicatesAll!="TRUE") %>% bind_rows(caves_dupl22_df2) %>% dplyr::select(-c(duplicates,duplicatesLast,duplicatesAll)) %>% ungroup() %>% left_join(species_occurencies_unique_caves3, by=c("Cave_ID_OLD"="Cave_ID"))
# 
# colnames_caves <- "Cave_ID,Cave_ID_OLD,CaveName,Cave_Comment,Cave_comment2,CaveReferences,Altitude,Longitude,Latitude,Location_Status,NearestVillage,Municipality,Island,County,Region,NAME,KWD_YPES,Municipalities_gr_original, Municipalities_gr,Municipalities_ISO_843,ID,objectid_NATURA,CODE_NATURA,area_NATURA,perimeter_NATURA,hectares_NATURA,SITETYPE_NATURA,PERIPHERY_NATURA,PREFECTURE_NATURA,NAME_LATIN_NATURA,area_katafygia_agrias_zwhs,FID_katafygia_agrias_zwhs,THESH_katafygia_agrias_zwhs,PERIFEREIA_katafygia_agrias_zwhs,EPOPTEYOYS_katafygia_agrias_zwhs,DHMOS_KOIN_katafygia_agrias_zwhs,NOMOS_katafygia_agrias_zwhs,EKTASH_katafygia_agrias_zwhs,APOFASH_katafygia_agrias_zwhs,FEK_katafygia_agrias_zwhs,EIDH_CHLOR_katafygia_agrias_zwhs,PANIDA_PTH_katafygia_agrias_zwhs,PANIDA_THI_katafygia_agrias_zwhs,PANIDA_PSA_katafygia_agrias_zwhs,PANIDA_ERP_katafygia_agrias_zwhs,PANIDA_AMF_katafygia_agrias_zwhs,area_strem_katafygia_agrias_zwhs,perimeter_katafygia_agrias_zwhs,Cave_References"
# 
# species_occurencies_all <- species_occurencies %>% dplyr::select(-c(CaveDescription,No_species_per_cave,Cave_ID,CaveName,Cave_Comment,Cave_comment2,CaveReferences,Altitude,Longitude,Latitude,Location_Status,NearestVillage,Municipality,Island,County,Region,NAME,KWD_YPES,Municipalities_gr_original, Municipalities_gr,Municipalities_ISO_843,ID,objectid_NATURA,CODE_NATURA,area_NATURA,perimeter_NATURA,hectares_NATURA,SITETYPE_NATURA,PERIPHERY_NATURA,PREFECTURE_NATURA,NAME_LATIN_NATURA,area_katafygia_agrias_zwhs,FID_katafygia_agrias_zwhs,THESH_katafygia_agrias_zwhs,PERIFEREIA_katafygia_agrias_zwhs,EPOPTEYOYS_katafygia_agrias_zwhs,DHMOS_KOIN_katafygia_agrias_zwhs,NOMOS_katafygia_agrias_zwhs,EKTASH_katafygia_agrias_zwhs,APOFASH_katafygia_agrias_zwhs,FEK_katafygia_agrias_zwhs,EIDH_CHLOR_katafygia_agrias_zwhs,PANIDA_PTH_katafygia_agrias_zwhs,PANIDA_THI_katafygia_agrias_zwhs,PANIDA_PSA_katafygia_agrias_zwhs,PANIDA_ERP_katafygia_agrias_zwhs,PANIDA_AMF_katafygia_agrias_zwhs,area_strem_katafygia_agrias_zwhs,perimeter_katafygia_agrias_zwhs,Cave_References)) %>% left_join(caves_filter,by=c("Cave_ID_OLD"="Cave_ID_OLD"))
# 
# write_delim(species_occurencies_all,"Cave_Fauna_of_Greece_Census_v3_16_01_2018.txt",delim = "\t")
# 
# species_occurencies_unique_caves4 <- species_occurencies_all %>% group_by(CaveName,Cave_ID, NearestVillage, Municipality,Island, County,Region,Cave_Comment,Latitude, Longitude,Altitude,Location_Status) %>% summarise(No_species_per_cave=n()) %>% ungroup()

# ###

species_occurencies$Genus <- as.character(lapply(strsplit(as.character(species_occurencies$Species), split=" "), "[", n=1))

species_occurencies$species_epithet <- as.character(lapply(strsplit(as.character(species_occurencies$Species), split=" "), "[", n=2))

species_occurencies$Species_bare_name <- do.call(paste, c(species_occurencies[c("Genus", "species_epithet")], sep = " ")) 

species_occurencies_unique_species <- species_occurencies %>% dplyr::select(Phylum, Class,Order,Family,Genus,Species,species_epithet,Species_bare_name) %>% distinct(.) %>% filter(species_epithet!="sp.")

species_occurencies_unique_species_all <- species_occurencies %>% dplyr::select(Phylum, Class,Order,Family,Genus,Species,species_epithet,Species_bare_name) %>% distinct(.)


species_occurencies_only_sp <- species_occurencies %>% dplyr::select(Species, species_epithet) %>% distinct() %>% filter(species_epithet=="sp.")

species_occurencies_unique_species_only_species <- species_occurencies_unique_species %>% dplyr::select(Species) %>% distinct()


```

There are `r nrow(species_occurencies_only_sp)` occurencies that only the genus is known.


```{r,warning=FALSE, message=FALSE, echo=FALSE}
#Count species and caves per taxon and department, respectively.

species_occurencies_unique_caves2 <- species_occurencies %>% group_by(Cave_ID,CaveName) %>% summarise(No_species_per_cave=n()) %>% ungroup() %>% mutate(duplicates=duplicated(Cave_ID,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Cave_ID,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE")))

# species_occurencies_unique_caves3 <- species_occurencies %>% distinct(CaveName,Cave_ID,NearestVillage, Municipality,Island, County,Altitude,Cave_References)
# species_occurencies_unique_caves32 <- species_occurencies_unique_caves3[,c(8,6,5,4,3,2,1,7)]

species_occurencies_unique_caves <- species_occurencies %>% group_by(CaveName,Cave_ID, NearestVillage, Municipality,Island, County,Region,Cave_Comment,Latitude, Longitude,Altitude,Location_Status,Cave_References) %>% summarise(No_species_per_cave=n()) %>% ungroup()

species_occurencies_unique_caves$Latitude <- as.numeric(species_occurencies_unique_caves$Latitude)
species_occurencies_unique_caves$Longitude <- as.numeric(species_occurencies_unique_caves$Longitude)
#write_delim(species_occurencies_unique_caves,"Caves_INFO_10_12_2017.txt",delim = "\t",col_names = T)

# Caves
caves_municipality <- species_occurencies %>% dplyr::select(CaveName, Municipality) %>% distinct() %>% group_by(Municipality) %>% summarize(number_of_caves=n()) %>% na.omit()

#write_delim(caves_municipality,path="INSPEE_database_caves_municipality.txt",delim = "\t",col_names = TRUE)

caves_county <- species_occurencies %>% dplyr::select(CaveName, County) %>% distinct() %>% group_by(County) %>% summarize(number_of_caves=n()) %>% na.omit()

#write_delim(caves_county,path="INSPEE_database_caves_county.txt",delim = "\t",col_names = TRUE)

caves_Region <- species_occurencies %>% dplyr::select(CaveName, Region) %>% distinct() %>% group_by(Region) %>% summarize(number_of_caves=n()) %>% na.omit()

#write_delim(caves_Region,path="INSPEE_database_species_Region.txt",delim = "\t",col_names = TRUE)

#Species

species_genus <- species_occurencies_unique_species %>% dplyr::select(Species,Genus) %>% distinct() %>% group_by(Genus) %>% summarise(number_of_species=n()) %>% na.omit()

#write_delim(species_genus,path="INSPEE_database_species_per_genus.txt",delim = "\t",col_names = TRUE)

species_family <- species_occurencies_unique_species %>% dplyr::select(Species,Family) %>% distinct() %>% group_by(Family) %>% summarise(number_of_species=n()) %>% na.omit()

#write_delim(species_family,path="INSPEE_database_species_per_family.txt",delim = "\t",col_names = TRUE)

species_order <- species_occurencies_unique_species %>% dplyr::select(Species,Order) %>% distinct() %>% group_by(Order) %>% summarise(number_of_species=n()) %>% na.omit()

#write_delim(species_order,path="INSPEE_database_species_per_order.txt",delim = "\t",col_names = TRUE)

species_class <- species_occurencies_unique_species %>% dplyr::select(Species,Class) %>% distinct() %>% group_by(Class) %>% summarise(number_of_species=n()) %>% na.omit()

#write_delim(species_class,path="INSPEE_database_species_per_class.txt",delim = "\t",col_names = TRUE)

species_Region <- species_occurencies %>% dplyr::select(Species,Region) %>% distinct() %>% group_by(Region) %>% summarise(number_of_species=n()) %>% na.omit()

#write_delim(species_class,path="INSPEE_database_species_Region.txt",delim = "\t",col_names = TRUE)

species_municipality <- species_occurencies %>% dplyr::select(Species, Municipality) %>% distinct() %>% group_by(Municipality) %>% summarize(number_of_species=n()) %>% na.omit()
```

There are 2545 species occurencies in `r nrow(species_occurencies_unique_caves)` caves of Greece with `r nrow(species_occurencies_unique_species)` different species. There are `r length(unique(species_occurencies_unique_species$Species))` different species in `r length(unique(species_occurencies_unique_species$Genus))` genera, in `r length(unique(species_occurencies_unique_species$Family))` families, in `r nrow(species_order)` orders, in `r length(unique(species_occurencies_unique_species$Class))` classes, in `r length(unique(species_occurencies_unique_species$Phylum))` phyla.

## Test export

```{r}

#export inspee

# species <- read_delim(file = "C:/Users/inikoloudakis/Downloads/Species_15-Feb-2018_165202.tsv",delim = "\t")
# census <- read_delim(file = "C:/Users/inikoloudakis/Downloads/Census_15-Feb-2018_165101.tsv",delim = "\t") %>% unite(col = Merged2,Species,Cave_Name,sep = ";",remove = F)
# caves <- read_delim(file = "C:/Users/inikoloudakis/Downloads/Caves_15-Feb-2018_094551.tsv",delim = "\t")
# Census_references <- read_delim(file = "C:/Users/inikoloudakis/Downloads/Census_references_15-Feb-2018_093414.tsv",delim = "\t")
# Cave_References <- read_delim(file = "C:/Users/inikoloudakis/Downloads/Cave_References_15-Feb-2018_093419.tsv",delim = "\t")

cave_references_import <- read_excel(path = "Cave_Fauna_Greece_Database_24_01_2018/Cave_references_FOR_DATABASE_09_01_2018.xlsx",col_names = T)

## mac

species <- read_delim(file = "/Users/savasp/Downloads/Species_16-Feb-2018_104829.tsv",delim = "\t")
census <- read_delim(file = "/Users/savasp/Downloads/Census_16-Feb-2018_104810.tsv",delim = "\t") %>% unite(col = Merged2,Species,Cave_Name,sep = ";",remove = F)
caves <- read_delim(file = "/Users/savasp/Downloads/Caves_16-Feb-2018_104856.tsv",delim = "\t")
Census_references <- read_delim(file = "/Users/savasp/Downloads/Census_references_16-Feb-2018_104900.tsv",delim = "\t")
Cave_References <- read_delim(file = "/Users/savasp/Downloads/Cave_References_16-Feb-2018_104904.tsv",delim = "\t")




species_occurencies4 <- species_occurencies %>% dplyr::select(Species,CaveName,Cave_ID, Locus_Typicus,Species_references,Locus_Typicus) %>% unite(col = Merged2,Species,CaveName,sep = ";",remove = F)

species_sav <- unique(species_occurencies4$Species)
species_man_census <- unique(census$Species)
species_man <- unique(species$`Species Full Name`)

ww_census <- species_sav[which(!(species_sav %in% species_man_census))]
ww_species <- species_sav[which(!(species_sav %in% species_man))]


dd_census <- species_occurencies4[which(!(species_occurencies4$Merged2 %in% census$Merged2)),]

species_occurencies_unique_caves <- species_occurencies %>% group_by(CaveName,Cave_ID, NearestVillage, Municipality,Island, County,Region,Cave_Comment,Latitude, Longitude,Altitude,Location_Status,Cave_References) %>% summarise(No_species_per_cave=n()) %>% ungroup()

species_occurencies_unique_caves_long_str <- strsplit(x = species_occurencies_unique_caves$Cave_References,split = ";")

species_occurencies_unique_caves_long <- data_frame(Cave_References=unlist(species_occurencies_unique_caves_long_str), Cave_ID=rep.int(species_occurencies_unique_caves$Cave_ID,times = sapply(species_occurencies_unique_caves_long_str,length)),CaveName=rep.int(species_occurencies_unique_caves$CaveName,times = sapply(species_occurencies_unique_caves_long_str,length))) %>% group_by(Cave_ID,CaveName,Cave_References) %>% summarise(n=n())

species_occurencies_unique_caves_long_str_man <- strsplit(x = caves$Cave_short_references,split = "|",fixed=TRUE)

species_occurencies_unique_caves_long_man <- data_frame(Cave_References=unlist(species_occurencies_unique_caves_long_str_man), Cave_ID=rep.int(caves$Cave_ID,times = sapply(species_occurencies_unique_caves_long_str_man,length)),CaveName=rep.int(caves$Cave_Name,times = sapply(species_occurencies_unique_caves_long_str_man,length))) %>% group_by(Cave_ID,CaveName,Cave_References) %>% summarise(n=n())


census_long_str_man <- strsplit(x = census$Reference_Short,split = "|",fixed=TRUE)
census_long_str_man_id <- strsplit(x = census$Reference_ID,split = "|",fixed=TRUE)

census_long_man <- data_frame(ReferenceShort=unlist(census_long_str_man),reference_id=unlist(census_long_str_man_id), Merged=rep.int(census$Merged2,times = sapply(census_long_str_man,length)),CaveName=rep.int(census$Cave_Name,times = sapply(census_long_str_man,length)),Cave_ID=rep.int(census$Cave_ID,times = sapply(census_long_str_man,length)),Census_id=rep.int(census$Census_ID,times = sapply(census_long_str_man,length)),Species=rep.int(census$Species,times = sapply(census_long_str_man,length))) %>% group_by(ReferenceShort,Cave_ID,CaveName,Species,Census_id) %>% summarise(n=n()) %>% ungroup() %>% mutate(Species=trimws(Species,"r")) %>% unite(col = Merged2,Species,CaveName,ReferenceShort,sep = ";",remove = F) %>% unite(col = MergedCave_spece,Species,CaveName,sep = ";",remove = F)


species_occurencies4_str <- strsplit(x = species_occurencies4$Species_references,split = ";")
species_occurencies4_long <- data_frame(ReferenceShort=unlist(species_occurencies4_str), Merged=rep.int(species_occurencies4$Merged2,times = sapply(species_occurencies4_str,length)),CaveName=rep.int(species_occurencies4$CaveName,times = sapply(species_occurencies4_str,length)),Cave_ID=rep.int(species_occurencies4$Cave_ID,times = sapply(species_occurencies4_str,length)),Species=rep.int(species_occurencies4$Species,times = sapply(species_occurencies4_str,length))) %>% mutate(CaveName=gsub(" or .*","",CaveName)) %>% group_by(ReferenceShort,Cave_ID,CaveName,Species) %>% summarise(n=n()) %>% ungroup() %>% unite(col = Merged2,Species,CaveName,ReferenceShort,sep = ";",remove = F) %>% unite(col = MergedCave_spece,Species,CaveName,sep = ";",remove = F)

# Locus typicus

census_inner <- census_long_man[which(census_long_man$Merged2 %in% species_occurencies4_long$Merged2),]
census_out <- census_long_man[which(!(census_long_man$Merged2 %in% species_occurencies4_long$Merged2)),]



occurencies_outcave <- species_occurencies4_long[which(!(species_occurencies4_long$CaveName %in% census_long_man$CaveName)),] %>% distinct(CaveName)

occurencies_outsp <- species_occurencies4_long[which(!(species_occurencies4_long$Species %in% census_long_man$Species)),] %>% distinct(Species)

occurencies_outcave_sp <- species_occurencies4_long[which(!(species_occurencies4_long$MergedCave_spece %in% census_long_man$MergedCave_spece)),] %>% distinct(Species,CaveName) %>% filter(!(Species %in% occurencies_outsp$Species), !(CaveName %in% occurencies_outcave$CaveName))

occurencies_out <- species_occurencies4_long[which(!(species_occurencies4_long$Merged2 %in% census_long_man$Merged2)),] %>% filter(!(Species %in% occurencies_outsp$Species), !(CaveName %in% occurencies_outcave$CaveName)) %>% group_by(Species,CaveName) %>% summarise(ss=toString(ReferenceShort))


species_cens <- species[which(!(species$Species_Full_Name %in% unique(species_occurencies4_long$Species))),]
#27367	924	Minotauria fagei (Kratochvil, 1970)	Spilaio Agias Sofias	22	Beron 2016|Fage 1945|Bosmans et al. 2013|Bosmans & Chatzaki 2005|Fage 1945|Bosmans et al. 2013|Bosmans & Chatzaki 2005	706|110|678|579|110|678|579


jj<- unique(grep("sp.", species_occurencies_unique_species_all$Species,fixed = T,value = T))
dd<- trimws(x = unique(grep("sp.", census$Species,fixed = T,value = T)),"r")

sp_niot <- dd[which(!(dd %in% jj))]

species_na <- species[which(is.na(species$Species_Full_Name)),]
species_sp <- species[grep("sp.", species$Species_Full_Name,fixed = T),]

```


## Resolve species names

With the taxize package we can resolve mispellings of species scientific names using the Global Names Resolver (GNR) service.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4609752/
#https://ropensci.org/tutorials/taxize_tutorial/

library('taxizesoap')

species_occurencies_unique_species_resolve <- gnr_resolve(names = species_occurencies_unique_species$Species,best_match_only = TRUE)

species_occurencies_unique_species_resolve_sum <- species_occurencies_unique_species_resolve %>% mutate(match=if_else(user_supplied_name==matched_name,paste0("TRUE"),paste0("FALSE")))

#pesi_search()
aa <- get_pesiid((head(species_occurencies_unique_species$Species)))

species_resolve_names_Global_Name <- species_occurencies_unique_species %>% left_join(species_occurencies_unique_species_resolve_sum, by=c("Species"="user_supplied_name")) %>% dplyr::select(-species_epithet,-Species_bare_name,-submitted_name)

# write_delim(species_resolve_names_Global_Name,"species_resolve_names_Global_Names_Resolver.txt",delim = "\t",col_names = T)

```


## Higher Taxonomy with R

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
library(taxize)
library(httr)

species_names <- as.vector(species_occurencies_unique_species$Species_bare_name)

species_uid <- sapply(species_names, function(x) get_uid(x,verbose = T,ask=F))

species_uid_df <- data.frame(Species_bare_name=names(species_uid), species_uid=species_uid)

aa <- get_nbnid(tail(species_occurencies_unique_species$Species_bare_name))

classification_species_uid <- classification("Acanthocreagris lycaonis",db = 'ncbi')

ss <- length(which(is.na(names(classification_species_uid))))


```

## Species occurencies-distributions from databases

### From GBIF


Get the species ids from Gbif with rgbif package.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
library(rgbif)
library(ISOcodes)
library(spocc)

splist <- species_occurencies_unique_species$Species
keys_gbif <- sapply(splist, function(x) name_backbone(x,rank = "species"))


keys_gbif_df <- data.frame(Data=unlist(keys_gbif), stringsAsFactors=FALSE) %>% mutate(Columns=rownames(.)) %>%
mutate(Species=gsub("(.*)\\.(.*)", "\\1",Columns), Variables=gsub("(.*)\\.(.*)", "\\2",Columns)) %>% dplyr::select(-Columns) %>% spread(Variables,Data)

#write_delim(keys_gbif_df,"Species_with_Gbif_ids.txt",delim = "\t")       


```

Get the occurencies data from Gbif.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
keys_gbif_df <- read_delim("Species_with_Gbif_ids.txt",delim = "\t",col_names = T)


start_time <- Sys.time()

gbif <- occ_data(taxonKey = na.omit(unique(keys_gbif_df$speciesKey)))

end_time <- Sys.time()

end_time-start_time
#Time difference of 9.739269 mins


list_dataframes <- list()

for(i in 1:length(gbif)){
  
  list_dataframes[[i]] <- gbif[[i]]$data
  
}

df <- do.call("bind_rows", list_dataframes)

df_in_our_database <- df %>% filter(scientificName %in% species_occurencies_unique_species$Species)

df_in_our_database_countries <- df %>% filter(scientificName %in% species_occurencies_unique_species$Species) %>% distinct(scientificName, country)%>% na.omit() %>% group_by(scientificName) %>% summarise(Countries_occurrences_GBIF=toString(country))

#write_delim(df_in_our_database_countries,"Species_with_Gbif_Occurencies.txt",delim = "\t")    

sss <- species_occurencies %>% filter(species_epithet!="sp.") %>% distinct(Species,Distribution_IUCN) 

sss2 <- sss %>% left_join(df_in_our_database_countries, by=c("Species"="scientificName")) %>% left_join(catalogue_life_taxa_in_Cave_fauna_Greece_dist,by=c("Species"="scientificName"))

sss3 <- sss2 %>% filter(!is.na(Countries_occurrences_GBIF) | !is.na(Distribution_IUCN) | !is.na(Distribution_CoT))

#write_delim(sss2,"Species_with_Distributions.txt",delim = "\t")    


```


### Species distributions IUCN

```{r}

species_occurencies_unique_species$speciesGSUB <- gsub(pattern = " ",replacement ="##",x = species_occurencies_unique_species$Species)


```


We downloaded the distribution countries for each species in our database from IUCN using the rredlist package.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

IUCN_token <- "0ec43516c25669cfd876387ab7f755d1d3745a6f39f4ee5a00b96bac1579cb42"

library(rredlist)
library(taxize)

#Time difference of 16.67948 mins
start_time <- Sys.time()

sss <- species_occurencies_unique_species$Species_bare_name

species_IUCN <- lapply(sss,function(x) rl_search(name = x,key = IUCN_token))


#iucn_species_summary <- sapply(sss,function(x) iucn_summary(sciname = x,key = IUCN_token))

#iucn_species_summary2 <- iucn_summary(sciname = sss,key = IUCN_token)

iucn_species_summary_dataframe <- as.data.frame(c())

to_df_iucn <- function(x){
  
y <- data.frame(Names=as.character(),Status=as.character(),Distribution=as.character(),Population_trend=as.character(),stringsAsFactors=FALSE) 

for(i in 1:length(x)) {
  
  y[i,1] <- as.character(names(x[i]))
  y[i,2] <- paste(as.character(x[[i]][1]),collapse = ";")
  y[i,3] <- paste(as.character(x[[i]][3]),collapse = ";")
  y[i,4] <- paste(as.character(x[[i]][4]),collapse = ";")
}
  y
}

#iucn_species_summary_dataframe <- to_df_iucn(iucn_species_summary)


x <- species_IUCN
  
  #y <- data.frame(Names=as.character(),Status=as.character(),Distribution=as.character(),Population_trend=as.character(),stringsAsFactors=FALSE) 

dat <- data.frame(i=as.numeric(),names=as.character(),status=as.character(),stringsAsFactors=FALSE)

   
for(i in 1:length(x)) {
  
  dat[i,1] <- i
  dat[i,2] <- paste(as.character(x[[i]][1]))
  dat[i,3] <- class(x[[i]]$result)=="data.frame"
  
  # y[i,1] <- as.character(names(x[i]))
  # y[i,2] <- paste(as.character(x[[i]][1]),collapse = ";")
  # y[i,3] <- paste(as.character(x[[i]][3]),collapse = ";")
  # y[i,4] <- paste(as.character(x[[i]][4]),collapse = ";")
  
}
  
  #l <- unlist(x,recursive = F)
  list_dataframes <- list(c())
  list_with_true <- x[which(dat$status=="TRUE")]
  
  for (j in 1:length(list_with_true)) {
    
    list_dataframes[[j]] <- as.data.frame(list_with_true[[j]][2])
    
  }

Species_in_IUCN <- do.call("rbind",list_dataframes)
  

end_time <- Sys.time()

end_time - start_time


#write_delim(Species_in_IUCN,path = "Species_in_IUCN.txt",delim = "\t",col_names = T)

```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
iucn_species_summary_dataframe <- read_csv(file = "iucn_species_summary_dataframe.csv",col_names = T) %>% distinct()
colnames(iucn_species_summary_dataframe)<-c("IUCN_Status","Distribution_IUCN","Population_trend_IUCN","Species_Name")

species_IUCN_enrichment <- species_occurencies_unique_species %>% left_join(.,iucn_species_summary_dataframe,by=c("Species_bare_name"="Species_Name")) %>% dplyr::select(Species,IUCN_Status,Distribution_IUCN,Population_trend_IUCN)

species_occurencies_unique_species_in_IUCN <- species_IUCN_enrichment %>% na.omit(IUCN_Status)

species_occurencies_unique_species_in_IUCN_table <- species_occurencies_unique_species_in_IUCN %>% left_join(species_occurencies_unique_species, by=c("Species"="Species")) %>% group_by(Order) %>% summarise(n=n())


```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
species_occurencies_unique_species_in_IUCN_table_caption <- "Only 43 species of Cave Fauna of Greece database are evaluated in IUCN database"
kable(species_occurencies_unique_species_in_IUCN_table,caption=species_occurencies_unique_species_in_IUCN_table_caption, align = 'l')

```


IUCN database has `r nrow(species_occurencies_unique_species_in_IUCN)` species from our database.  

### Species distributions from Catalogue of Life

From the Catalogue of Life.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
## Load the data Catalogue of Life


catalogue_life_description <- read_delim(file = "/Users/savasp/Desktop/archive-kingdom-animalia-bl3-2/description.txt",delim = "\t",col_names = TRUE)

catalogue_life_reference <- read_delim(file = "/Users/savasp/Desktop/archive-kingdom-animalia-bl3-2/reference.txt",delim = "\t",col_names = TRUE)

catalogue_life_distribution <- read_delim(file = "/Users/savasp/Desktop/archive-kingdom-animalia-bl3-2/distribution.txt",delim = "\t",col_names = TRUE)

catalogue_life_taxa <- read_delim(file = "/Users/savasp/Desktop/archive-kingdom-animalia-bl3-2/taxa.txt",delim = "\t",col_names = TRUE)

## From our database

catalogue_life_taxa_in_Cave_fauna_Greece <- catalogue_life_taxa %>% filter(scientificName %in% unique(species_occurencies_unique_species$Species))


catalogue_life_taxa_in_Cave_fauna_Greece_dist <- catalogue_life_distribution %>% filter(taxonID %in% catalogue_life_taxa_in_Cave_fauna_Greece$taxonID) %>% left_join(catalogue_life_taxa_in_Cave_fauna_Greece,by=c("taxonID"="taxonID")) %>% group_by(taxonID) %>% summarise(Distribution_CoT=toString(locality)) %>% left_join(catalogue_life_taxa_in_Cave_fauna_Greece,by=c("taxonID"="taxonID")) %>% distinct(scientificName,Distribution_CoT)

catalogue_life_taxa_in_Cave_fauna_Greece_reference <- catalogue_life_reference %>% filter(taxonID %in% catalogue_life_taxa_in_Cave_fauna_Greece$taxonID) %>% left_join(catalogue_life_taxa_in_Cave_fauna_Greece,by=c("taxonID"="taxonID"))

catalogue_life_taxa_in_Cave_fauna_Greece_description <- catalogue_life_description %>% filter(taxonID %in% catalogue_life_taxa_in_Cave_fauna_Greece$taxonID) %>% left_join(catalogue_life_taxa_in_Cave_fauna_Greece,by=c("taxonID"="taxonID"))


```


## Species protection status

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
species_protection_status <- read_xlsx(path = "Species_Protection_Status_for_Kaloust_Working_13.12.2107.xlsx",col_names = T,sheet = "SpeciesPS") %>% dplyr::select(-c(PhylumOrDivision, Class,Order,Family,Genus,species_epithet,Species_bare_name,Protected,H))

species_protection_status[species_protection_status=="NA"] <- NA

species_protection_status_categories <- t(read_xlsx(path = "Species_Protection_Status_for_Kaloust_Working_13.12.2107.xlsx",col_names = F,sheet = "Apend"))

species_protection_status$A <- with(species_protection_status,ifelse(is.na(A),NA_character_,species_protection_status_categories[3,1]))

species_protection_status$B <- with(species_protection_status,ifelse(is.na(B),NA_character_,species_protection_status_categories[3,2]))

species_protection_status$C <- with(species_protection_status,ifelse(is.na(C),NA_character_,ifelse(C=="IV",species_protection_status_categories[3,4],species_protection_status_categories[3,3])))

species_protection_status$D <- with(species_protection_status,ifelse(is.na(D),NA_character_,species_protection_status_categories[3,5]))

species_protection_status$E <- with(species_protection_status,ifelse(is.na(E),NA_character_,ifelse(E=="II",species_protection_status_categories[3,6],species_protection_status_categories[3,7])))

species_protection_status$F <- with(species_protection_status,ifelse(is.na(F),NA_character_,species_protection_status_categories[3,8]))

species_protection_status$G <- with(species_protection_status,ifelse(is.na(G),NA_character_,ifelse(G=="I/A",species_protection_status_categories[3,9],species_protection_status_categories[3,10])))

#species_protection_status$H <- with(species_protection_status,ifelse(is.na(H),NA_character_,species_protection_status_categories[3,11]))

#species_protection_status[is.na(species_protection_status)] <- "There is no species-specific legal framework for protection"

colnames(species_protection_status) <- c("Species","Protection_Law_86/1969","Protection_Presidential_Decree 67/1981","Protection_Habitats_Directive_(92/43/EEC)","Protection_Birds_Directive_(79/409/EEC)","Protection_Bern_Convection","Protection_Bonn_Convection","Protection_CITES")

#species_occurencies2 <- species_occurencies %>% left_join(species_protection_status, by=c("Species"="Species"))

#write_delim(x = species_occurencies2,path = "Cave_Fauna_of_Greece_Census_14_12_2017.txt",delim = "\t",col_names = T)

```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
species_protection_status <- species_occurencies %>% dplyr::select("Species","Protection_Law_86/1969","Protection_Presidential_Decree 67/1981","Protection_Habitats_Directive_(92/43/EEC)","Protection_Birds_Directive_(79/409/EEC)","Protection_Bern_Convection","Protection_Bonn_Convection","Protection_CITES") %>% distinct(.)

```


## Troglofauna characterisation

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

Troglofauna_characterisation <- data_frame(Troglofauna_characterisation_AB=c("tx","tx?","tph","tph?","tb","tb?","ac","ac?"),Troglofauna_characterisation=c("Trogloxene","Trogloxene?","Troglophile", "Troglophile?","Troglobiont", "Troglobiont?","Accidental","Accidental?") )


species_troglofauna_characterisation <- species_occurencies %>% dplyr::select(Species,species_epithet,Type) %>% distinct(.) %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% dplyr::select(-duplicatesLast,-duplicates) %>% filter(!(duplicatesAll=="TRUE" & is.na(Type))) %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% dplyr::select(-duplicatesLast,-duplicates) %>% mutate(Troglofauna_characterisation_AB=if_else(duplicatesAll=="TRUE",NA_character_,Type)) %>% distinct(Species,Troglofauna_characterisation_AB) %>% left_join(Troglofauna_characterisation, by=c("Troglofauna_characterisation_AB"="Troglofauna_characterisation_AB"))


#species_occurencies_unique_species_all
#%>% filter(!(is.na(Type) & duplicatesAll=="TRUE")) %>% distinct() %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll_misspell=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE")))

# species_occurencies_unique_species2 <- species_occurencies %>% dplyr::select(Phylum, Class,Order,Family,Genus,Species,species_epithet,Species_bare_name,Synonymes,Type,Speciment_Abbreviations,Species_comment,Comments) %>% distinct(.) %>% filter(species_epithet!="sp.") %>% dplyr::select(Species,Type)
# 
# species_occurencies_unique_species222 <- species_occurencies %>% dplyr::select(Species,species_epithet,Type) %>% distinct(.)
# #%>% filter(species_epithet!="sp.") %>% dplyr::select(Species,Type)   Synonymes,Type,Speciment_Abbreviations,Species_comment,Comments
# 

########

# species_occurencies_unique_species2_type <- species_occurencies_unique_species2 %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% dplyr::select(-duplicatesLast,-duplicates) %>% filter(!(is.na(Type) & duplicatesAll=="TRUE")) %>% distinct() %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll_misspell=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE")))
# 
# species_occurencies_unique_species2_type_ok <- species_occurencies_unique_species2_type %>% mutate(., Type2 = if_else(duplicatesAll_misspell=="TRUE","NA",Type)) %>% filter(!(Type2=="NA" & duplicates=="TRUE")) %>% dplyr::select(Species, Type2)
# 
# species_occurencies_unique_species2_type_ok[species_occurencies_unique_species2_type_ok=="NA"] <- NA
# colnames(species_occurencies_unique_species2_type_ok) <- c("Species", "Troglofauna_characterisation_AB")
# 
# 
# species_occurencies_unique_species1 <- species_occurencies_unique_species %>% left_join(.,species_occurencies_unique_species2_type_ok, by=c("Species"="Species")) %>% left_join(.,Troglofauna_characterisation, by=c("Troglofauna_characterisation_AB"="Troglofauna_characterisation_AB"))



```

Summary table with the species characterisations. 


```{r, warning=FALSE, message=FALSE, echo=FALSE}
species_troglofauna_characterisation <- species_occurencies %>% distinct(Species,species_epithet,Troglofauna_characterisation)

species_occurencies_unique_species_troglofauna_summary <- species_troglofauna_characterisation %>% group_by(Troglofauna_characterisation) %>% summarise(number_of_species=n())

species_occurencies_unique_species_troglofauna_summary_captio <- "Number of species per troglofauna characterisation"
kable(species_occurencies_unique_species_troglofauna_summary,caption=species_occurencies_unique_species_troglofauna_summary_captio, align = 'l')
```


## Species hyperlinks in databases


```{r,warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

species_Conservation_links_file <-  species_occurencies %>% dplyr::select(Species,CheckIUCNRedList,CheckPESI,CheckFaunaEuropaea,CheckGBIF,CheckNCBI) %>% distinct(.)


species_Conservation_links <- species_occurencies_unique_species %>% dplyr::select(Species) %>% left_join(.,species_Conservation_links_file, by=c("Species"="Species"))

species_links_summary <- data_frame(Source=c("CheckFaunaEuropaea","CheckNCBI","CheckGBIF","CheckPESI","CheckIUCNRedList"), Number_of_links=c(sum(!is.na(species_Conservation_links$CheckFaunaEuropaea)),sum(!is.na(species_Conservation_links$CheckNCBI)),sum(!is.na(species_Conservation_links$CheckGBIF)),sum(!is.na(species_Conservation_links$CheckPESI)),sum(!is.na(species_Conservation_links$CheckIUCNRedList))), Missing_links=c(nrow(species_occurencies_unique_species)-sum(!is.na(species_Conservation_links$CheckFaunaEuropaea)),nrow(species_occurencies_unique_species)-sum(!is.na(species_Conservation_links$CheckNCBI)),nrow(species_occurencies_unique_species)-sum(!is.na(species_Conservation_links$CheckGBIF)),nrow(species_occurencies_unique_species)-sum(!is.na(species_Conservation_links$CheckPESI)),nrow(species_occurencies_unique_species)-sum(!is.na(species_Conservation_links$CheckIUCNRedList))))

species_links_summary_caption <- "Links to different databases for individual species"
kable(species_links_summary,caption=species_links_summary_caption, align = 'l')

####

# links_Giannis <- read_xlsx("species_for_links_OK_15_01_2018_GIANNIS.xlsx",col_names = T) %>% dplyr::select(Species, CheckGBIF)
# 
# links_Kaloust <- read_xlsx("species_for_links_OK_15_01_2018_Kaloust.xlsx",col_names = T) %>% dplyr::select(Species,CheckFaunaEuropaea,CorrectSpeciesName)
# links_Savvas <- read_xlsx("species_for_links_OK_15_01_2018_Savvas.xlsx",col_names = T) %>% dplyr::select(Species,CheckPESI)
# 
# species_links <- links_Kaloust %>% left_join(links_Giannis, by=c("Species"="Species")) %>% left_join(links_Savvas, by=c("Species"="Species")) %>% mutate(CorrectSpeciesName=if_else(is.na(CorrectSpeciesName),Species,CorrectSpeciesName))
# 
# species_links[species_links=="NA"] <- NA
# 
# colnames(species_links)[1] <- "Species_2018_2"
# colnames(species_links)[3] <- "Species"

#colnames(species_occurencies)[38] <- "Species_2018_2"

#species_occurencies_links <- species_occurencies %>% dplyr::select(-c(CheckPESI,CheckFaunaEuropaea,CheckGBIF)) %>% left_join(species_links,by=c("Species_2018_2"="Species_2018_2"))

#write_delim(species_occurencies_links,path = "Cave_Fauna_of_Greece_Census_v4_17_01_2018.txt",col_names = T,delim = "\t")

# NCBI LINKS
# first we find the NCBI ids with the taxise package and afterwards we create the links. According to their site in this link https://www.ncbi.nlm.nih.gov/Taxonomy/taxonomyhome.html/index.cgi?chapter=howlink we use the ids and a url prefix to create the urls.

species_names <- as.vector(species_occurencies_unique_species$Species_bare_name)

species_uid <- sapply(species_names, function(x) get_uid(x,verbose = T,ask=F))

species_uid_df <- data.frame(Species_bare_name=names(species_uid), species_uid=as.numeric(species_uid),row.names = NULL)

species_uid_df_no_na <-  species_uid_df %>% na.omit() %>% mutate(NCBI_links=paste("https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?id=",species_uid,sep = "")) %>% left_join(species_occurencies_unique_species_all, by=c("Species_bare_name"="Species_bare_name"))

write_delim(species_uid_df_no_na,path = "species_uid_df_no_na.txt",delim = "\t")

# Open all tabs

#sapply(species_uid_df_no_na$NCBI_links,FUN = browseURL)

species_occurencies2 <- species_occurencies %>% left_join(species_uid_df_no_na, by=c("Species_bare_name"="Species_bare_name"))

species_Conservation_linksNCBI <- species_Conservation_links %>% dplyr::select(Species,CheckNCBI) %>% na.omit 


```


In the case of IUCN database there are missing links because these species are not included in the databese. This has to be clarified for the rest databases. 


Get ready the species data.
```{r}

# species_Data_Cave_Fauna_Greece <- species_occurencies_unique_species %>% left_join(species_troglofauna_characterisation, by=c("Species"="Species")) %>% left_join(species_IUCN_enrichment, by=c("Species"="Species")) %>% left_join(species_Conservation_links, by=c("Species"="Species"))

#write_delim(x = species_Data_Cave_Fauna_Greece,path = "Cave_Fauna_of_Greece_Species_10_12_2017.txt",delim = "\t",col_names = T)

```

## Last additions

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

species_occurencies_only_sp2 <- species_occurencies_only_sp %>% dplyr::select(Species) %>% mutate(Species_2018=Species)

species_troglofauna_distributions <- read_xlsx(path = "Species_Chorology_and Troglofauna characterisation_11.01.2018.xlsx",col_names = T) %>% mutate(Species_2018=ifelse(is.na(`Correct Species name`),paste0(Species), paste0(`Correct Species name`))) %>% dplyr::select(Species,Species_2018,COMMENTS,Troglofauna_characterisation,Distribution) %>% bind_rows(.,species_occurencies_only_sp2)

colnames(species_troglofauna_distributions)[3] <- "Species_Comments_2018"
colnames(species_troglofauna_distributions)[5] <- "Distribution_INSPEE"

distribution_INSPEE <- species_troglofauna_distributions %>% group_by(Distribution_INSPEE) %>% summarise(Dist=n())


```


```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
## New species occurences file with species!! 
species_greek_red_data <- read_xlsx("Species_FOR_GREEK_RED_DATA_BOOK_plus_Beron.xlsx",col_names = T) %>% dplyr::select(Species,Status_Greek_Red_Data_Book)

species_occurencies_dist_troglo <- species_occurencies %>% dplyr::select(-Troglofauna_characterisation) %>% left_join(species_troglofauna_distributions, by=c("Species_Old"="Species")) %>% dplyr::filter(Species_2018!="DELETE") %>% left_join(species_greek_red_data, by=c("Species_Old"="Species"))

species_occurencies_dist_troglo$Genus <- as.character(lapply(strsplit(as.character(species_occurencies_dist_troglo$Species_2018), split=" "), "[", n=1))

species_Data_Cave_Fauna_Greece <- species_occurencies_dist_troglo %>% dplyr::select(Phylum,Class,Order,Family,Genus,Species_2018,CheckIUCNRedList,CheckPESI,CheckNCBI,CheckFaunaEuropaea) %>% distinct(.) %>% mutate(duplicates=duplicated(Species_2018,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species_2018,fromLast = T)) %>% mutate(duplicatesAll_misspell=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% dplyr::select(-c(duplicatesLast,duplicates)) %>% filter(!(duplicatesAll_misspell=="TRUE" & is.na(CheckPESI) & is.na(CheckNCBI) & is.na(CheckFaunaEuropaea))) %>% filter(!(Species_2018=="Eurygyrus oertzeni (Verhoeff, 1901)" & is.na(CheckNCBI) & is.na(CheckFaunaEuropaea))) %>% dplyr::select(-c(Phylum,Class,Order,Family,Genus,duplicatesAll_misspell))

species_higher_taxonomy <- read_xlsx("Cave_fauna_of_greece_species_for_DATABASE_15_01_2018_matched-FINAL.xlsx", col_names = T) %>% mutate(Species_ready=if_else(is.na(CorrectSpeciesName),ScientificName,CorrectSpeciesName )) %>% dplyr::select(-CorrectSpeciesName) %>% left_join(species_Data_Cave_Fauna_Greece, by=c("ScientificName"="Species_2018")) %>% dplyr::select(-ScientificName) %>% distinct(.) %>% mutate(duplicates=duplicated(Species_ready,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species_ready,fromLast = T)) %>% mutate(duplicatesAll_misspell=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% filter(!(duplicatesAll_misspell=="TRUE" & is.na(CheckPESI) & is.na(CheckNCBI) & is.na(CheckFaunaEuropaea))) %>% filter(!(Species_ready=="Acanthopetalum cycladicum (Verhoeff, 1901)" & is.na(CheckFaunaEuropaea))) %>% dplyr::select(-c(duplicates,duplicatesAll_misspell,duplicatesLast))

species_higher_taxonomy_ready <- read_xlsx("Cave_fauna_of_greece_species_for_DATABASE_15_01_2018_matched-FINAL.xlsx", col_names = T) %>% mutate(Species_ready=if_else(is.na(CorrectSpeciesName),ScientificName,CorrectSpeciesName )) %>% dplyr::select(-c(CorrectSpeciesName,Phylum,Class,Order,Family,Genus)) %>% left_join(species_higher_taxonomy,by=c("Species_ready"="Species_ready"))

species_occurencies_species_data_all <- species_occurencies_dist_troglo %>% dplyr::select(-c(Phylum,Class,Order,Family,Genus,CheckIUCNRedList,CheckPESI,CheckNCBI,CheckFaunaEuropaea)) %>% left_join(species_higher_taxonomy_ready, by=c("Species_2018"="ScientificName"))

species_for_links <- species_occurencies %>% distinct(Species,CheckIUCNRedList,CheckGBIF,CheckPESI,CheckNCBI,CheckFaunaEuropaea) %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll_misspell=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% filter(!(duplicatesAll_misspell=="TRUE" & is.na(CheckGBIF))) %>% dplyr::select(-c(duplicatesAll_misspell,duplicatesLast,duplicates)) %>% mutate(duplicates=duplicated(Species,fromLast = F)) %>% mutate(duplicatesLast=duplicated(Species,fromLast = T)) %>% mutate(duplicatesAll_misspell=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% mutate(Species_for_Search=Species)

#write_delim(x = species_for_links,path = "species_for_links_15_01_2018.txt",delim = "\t",col_names = T)

```

# Caves in database


```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

cave_references <- read_xlsx(path = "Cave_references_FOR_DATABASE_09_01_2018.xlsx",col_names = T)


caves_with_references <- read_xlsx(path = "Caves_for_Description_11_01_2018.xlsx", col_names = T)

caves_with_references$Cave_References <- gsub(pattern = ", ",replacement = ";",x = caves_with_references$Cave_References)


cave_short_references <- strsplit(x = caves_with_references$Cave_References,split = ";")
cave_short_references_df <- data_frame(Cave_References=unlist(cave_short_references), Cave_ID=rep.int(caves_with_references$Cave_ID,times = sapply(cave_short_references,length)),CaveName=rep.int(caves_with_references$CaveName,times = sapply(cave_short_references,length))) %>% na.omit()

cave_short_references_df_toString <- cave_short_references_df %>% group_by(Cave_ID) %>% summarise(Cave_References=paste(Cave_References,collapse = ";"))

# Which cave reference annotations doesn't appear in the cave references file.

mistakes_cave_short_references <- cave_short_references_df[which(!(cave_short_references_df$Cave_References %in% cave_references$Cave_Short_Reference)),]

cave_short_references_used <- cave_short_references_df[which((cave_short_references_df$Cave_References %in% cave_references$Cave_Short_Reference)),]



```

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
## Update with caves. 

caves_last_mistakes <- read_xlsx("caves_last_mistakes_12_01_2017.xlsx",col_names = T) %>% mutate(Cave_ID_2018=ifelse(is.na(`Correct Cave`),paste0(Cave_ID), paste0(`Correct Cave`)))

species_occurencies_unique_caves_all_info_file <- read_xlsx("Cave_Fauna_of_Greece_Caves_10_12_2017.xlsx", col_names = T) %>% left_join(cave_short_references_df_toString, by=c("Cave_ID"="Cave_ID"))

species_occurencies_unique_caves_all_info_N <- species_occurencies_unique_caves_all_info_file %>% dplyr::select(-c(CaveName,NearestVillage,Municipality,Island,County,Region,Latitude,Longitude,Municipalities_ISO_843)) %>% filter(Cave_ID %in% caves_last_mistakes$Cave_ID) %>% left_join(caves_last_mistakes, by=c("Cave_ID"="Cave_ID"))

species_occurencies_unique_caves_all_info_2018 <- species_occurencies_unique_caves_all_info_file %>% filter(!(Cave_ID %in% caves_last_mistakes$Cave_ID)) %>% bind_rows(species_occurencies_unique_caves_all_info_N)

species_occurencies_unique_caves_all_info_2018_occ <- species_occurencies_unique_caves %>% mutate(Cave_ID_OLD=Cave_ID, Census_Merge=paste(Species,Cave_ID_OLD,CaveName,Species_references,sep = ";")) %>% dplyr::select(-which(colnames(species_occurencies_species_data_all) %in% colnames(species_occurencies_unique_caves_all_info_2018))) %>% left_join(species_occurencies_unique_caves_all_info_2018, by=c("Cave_ID_OLD"="Cave_ID")) %>% mutate(Delete=ifelse(is.na(Delete), "Keep",Delete)) %>% filter(Delete!="Delete") %>% mutate(Cave_ID_2018=ifelse(is.na(Cave_ID_2018), Cave_ID_OLD,Cave_ID_2018)) %>% dplyr::select(-c(Delete, `Correct Cave`))

#write_delim(species_occurencies_unique_caves_all_info_2018_occ,path = "Cave_Fauna_of_Greece_Census_v2_15_01_2018.txt",col_names = T,delim = "\t")

caves_Cave_Fauna_of_Greece <- species_occurencies_unique_caves_all_info_2018_occ %>% distinct(Cave_ID_2018, CaveName, Longitude, Latitude)

```


```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

caves_new_names <- read_xlsx(path = "DataBaseCavesWORKING_DOC_04_12_2017.xlsx",col_names = TRUE) %>% unite(col = Merged,OldCaveName, NearestVillage, Cave_Comment,sep = ";",remove = F) %>% mutate(New_names=if_else(is.na(CorrectCaveName),paste(OldCaveName),paste(CorrectCaveName)),Location_status2=if_else(is.na(Location_status),"Location known",paste(Location_status)),Correct_CaveID_2=if_else(is.na(Correct_CaveID),paste(CaveID),paste(Correct_CaveID)))

caves_new_names$Cave_Comment <- ifelse(caves_new_names$Cave_Comment=="NA",NA,paste(caves_new_names$Cave_Comment))

caves_new_names$Cave_Comment_2 <- ifelse(caves_new_names$Cave_Comment_2=="NA",NA,paste(caves_new_names$Cave_Comment_2))


caves_Correct_CaveID <- caves_new_names %>% dplyr::select(Correct_CaveID_2) %>% left_join(caves_new_names,by=c("Correct_CaveID_2"="CaveID")) %>%  dplyr::select(-Correct_CaveID_2.y, -Correct_CaveID, -NearestVillage, -Merged,-OldCaveName,-CorrectCaveName,-Location_status) %>% distinct() %>% mutate(Cave_comments= if_else(!is.na(Cave_Comment_2) & is.na(Cave_Comment), paste(Cave_Comment_2),if_else(is.na(Cave_Comment_2) & !is.na(Cave_Comment), paste(Cave_Comment),if_else(is.na(Cave_Comment_2) & is.na(Cave_Comment),paste(NA),if_else(Cave_Comment_2==Cave_Comment,paste(Cave_Comment),paste(Cave_Comment_2, Cave_Comment, sep = ";")))))) %>% unite(Cave_comments, Cave_comments,COMMENT,sep = ";",remove = TRUE) %>% dplyr::select(-Cave_Comment_2,-Cave_Comment)

colnames(caves_Correct_CaveID) <- c("Cave_ID","Cave_comments", "Latitude","Longtitude","Altitude","Nearest_Village","Municipality","County","Region","Cave_Name", "Location_Status")

#caves_Correct_CaveID <- caves_Correct_CaveID[,c(1,10,2,3,4,5,6,7,8,9,11)]

caves_Correct_CaveID$Cave_comments <- ifelse(caves_Correct_CaveID$Cave_comments=="NA;NA" |caves_Correct_CaveID$Cave_comments=="NA",NA,paste(caves_new_names$Cave_Comment))


#allagi onomaton spilaion

# species_occurencies_unique_caves_s <- species_occurencies_unique_caves %>% unite(col = Merged,CaveName, NearestVillage,Cave_Comment,sep = ";",remove = T) %>% dplyr::select(-Municipality,-County,-Region)
# 
# caves_merged <- species_occurencies_unique_caves_s %>% left_join(caves_new_names,by=c("Merged"="Merged"))

cave_ids <- caves_new_names %>% dplyr::select(CaveID,Correct_CaveID_2,Merged)

species_occurencies_new_caves <- species_occurencies %>% unite(col = Merged,CaveName, NearestVillage,Cave_Comment,sep = ";",remove = T) %>% dplyr::select(-Municipality,-County,-Region) %>% left_join(cave_ids,by=c("Merged"="Merged")) %>% dplyr::select(-CaveID) %>% left_join(caves_Correct_CaveID,by=c("Correct_CaveID_2"="Cave_ID"))


#write_delim(species_occurencies_new_caves,"species_occurencies_new_caves.txt",delim = "\t",col_names = T)


```



## Cave references

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Get ready the cave references file

# cave_references$Year <- as.numeric(gsub(pattern = "\\.",replacement = "",x = cave_references$Year))
# 
# cave_references$Journal <- gsub(pattern = "\\,",replacement = "",x = cave_references$Journal)
# 
# cave_references$Pages <- gsub(pattern = "\\.",replacement = "",x = cave_references$Pages)
# 
# cave_references$Title <- gsub(pattern = "\\.",replacement = "",x = cave_references$Title)
# cave_references$Title <- paste0(cave_references$Title,".")
# 
# write_delim(cave_references,path = "Cave references FOR DATABASE_09_01_2018.txt",delim = "\t",col_names = T)

```


We are using `r length(unique(species_occurencies$Cave_References))` cave references. There are `r length(which(is.na(unique(species_occurencies$Cave_References))))` without reference.


# References

## References from Mendeley
Get ready the references for the database.

```{bash, warning=FALSE, message=FALSE, echo=FALSE}
#Transform the .ris file to txt

#, engine.path="/Users/savasp/Dropbox/Ινστιτούτο Σπηλαιολογικών Ερευνών Ελλάδας/Conservation of the cave fauna of Greece - MAVA/Cave_Fauna_database"

Sed 's/  - /@/g' Cave_Fauna_References_23_01_2018.ris > Cave_Fauna_References_23_01_2018.txt
```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Instead of using JabRef!!! Do this:
# From txt long to dataframe wide.
references_from_ris <- read_delim(file = "Cave_Fauna_References_23_01_2018.txt",delim = "@",col_names = FALSE)

references_from_ris$X1 <- trimws(references_from_ris$X1,which = "right")

references_from_ris <- references_from_ris %>% mutate(id=cumsum(if_else(X1=="ER",1,0))) %>% group_by(id,X1) %>% summarise(Value=paste0(X2,collapse = ";")) %>% ungroup() 

references_from_ris <- references_from_ris[!references_from_ris$id==max(references_from_ris$id),]

references_from_ris_wide <- references_from_ris %>% spread(X1,Value)


## colnames

colnames(references_from_ris_wide) <- c("Id","Author","Place_Published","DOI","Editor","End_Page","ER","Edition","Issue","Journal","Keywords", "Link_to_PDF","Notes","Abstract","Publisher","ISBN","Start_Page","Title","Type","URL","Volume","Year")

#sss <- c("id" ,"A1", "CY", "DO", "ED", "EP", "ER", "ET", "IS", "JF", "KW", "L1", "N1", "N2", "PB", "SN", "SP", "T1","TY" ,"UR", "VL", "Y1")

references_from_ris_wide <- references_from_ris_wide[,c(1,2,18,22,10,21,9,17,6,5,8,15,3,16,4,19,20,12,13,14,11,7)]

references_from_ris_wide$Year <- trimws(gsub("///","",references_from_ris_wide$Year),which = "left")


```

## Creation of short references

```{r, warning=FALSE, message=FALSE, echo=FALSE}
## Create unique short references

references_from_ris_wide$n_authors <- str_count(references_from_ris_wide$Author, pattern = ";") +str_count(references_from_ris_wide$Author, pattern = "&") +1

references_from_ris_wide$first_author <- gsub("^(.*?),.*", "\\1", references_from_ris_wide$Author)

references_from_ris_wide$second_author <- gsub(pattern = ".*;(.+?),.*",replacement = "\\1",references_from_ris_wide$Author)  #"; *([^.,]*)"


references_from_ris_wide$Pages <- with(references_from_ris_wide, ifelse(Start_Page==End_Page,paste0(Start_Page),paste0(Start_Page,"-",End_Page)))

references_from_ris_wide$short_reference <- with(references_from_ris_wide,ifelse(n_authors==1,paste0(first_author," ",Year),ifelse(n_authors==2,paste0(first_author," & ",second_author," ",Year),paste0(first_author," et al. ",Year))))

species_references_ready_ris <- references_from_ris_wide %>% group_by(short_reference) %>% mutate(n_dupl_citation=letters[1:n()]) %>% mutate(n_dupl_citation_number=n()) %>% mutate(short_reference_ready=if_else(n_dupl_citation_number==1,paste0(short_reference),paste0(short_reference,n_dupl_citation))) %>% ungroup() %>% dplyr::select(-short_reference,-second_author,-Start_Page,-End_Page,-n_authors,-first_author,-second_author,-n_dupl_citation,-n_dupl_citation_number,-ER)

## Initials of Authors 

species_references_author <- strsplit(x = as.character(species_references_ready_ris$Author), "[;]")

species_references_author_spreaded <- data.frame(short_reference_ready = rep.int(species_references_ready_ris$short_reference_ready,sapply(species_references_author, length)),Author = rep.int(species_references_ready_ris$Author,sapply(species_references_author, length)), Author_spread = gsub("^\\s|\\s$", "",unlist(species_references_author))) 


Last_names <- gsub(",.*", "\\1", species_references_author_spreaded$Author_spread,perl = TRUE)

sort_names_initials <- iconv(gsub("[:a-z:]|\\s|\\.|[[:punct:]]", "", gsub(".*,", "\\1", species_references_author_spreaded$Author_spread,perl = TRUE)), "UTF-8", "ASCII", sub = "")
 #\\B\\w

sort_names_initials_ready <- trimws(gsub("([A-Z])", "\\1. ", sort_names_initials),which = "right")

species_references_author_spreaded$Author_spread_Initials <- paste0(Last_names,", ",sort_names_initials_ready)

species_references_author <- species_references_author_spreaded %>% group_by(short_reference_ready) %>% summarise(Author=paste0(Author_spread_Initials,collapse="; ")) %>% mutate(Author=gsub(";",",",gsub("(.*)\\;(.*)", "\\1 &\\2",Author)))


## Combine and Ready

species_references_ready_ris_final <- species_references_ready_ris %>% dplyr::select(-Author) %>% left_join(.,species_references_author,by=c("short_reference_ready"="short_reference_ready"))

species_references_ready_ris_final$Year <- as.numeric(species_references_ready_ris_final$Year)


species_references <- species_references_ready_ris_final

#write_delim(x = species_references,path = "Cave_Fauna_of_Greece_References_23_01_2018.txt",col_names = T,delim = "\t")

```


## Samplings over time


```{r,warning=FALSE, message=FALSE, echo=FALSE}


species_occurencies_2 <- strsplit(x = as.character(species_occurencies$Species_references), ";")

species_references_spreaded <- data.frame(Census_ID = rep.int(species_occurencies$Census_ID, sapply(species_occurencies_2, length)), Species_references_spread = unlist(species_occurencies_2)) %>% group_by(Census_ID) 

species_references_spreaded_unique <- species_references_spreaded %>% group_by(Species_references_spread) %>% summarise(ref_count=n()) %>% ungroup() %>% na.omit()

which(!(species_references_spreaded_unique$Species_references_spread %in% species_references$short_reference_ready),useNames = TRUE)

Cave_Fauna_of_Greece_Census_LONG <- species_references_spreaded %>% left_join(species_occurencies,by=c("Census_ID"="Census_ID")) %>% left_join(species_references,by=c("Species_references_spread"="short_reference_ready")) %>% ungroup()

Cave_Fauna_of_Greece_Census_LONG_small <- Cave_Fauna_of_Greece_Census_LONG %>% dplyr::select(Cave_ID,CaveName,Species_references_spread, Species)

Cave_Fauna_of_Greece_Census_LONG_small2 <- Cave_Fauna_of_Greece_Census_LONG_small %>% unite(col =merged, Cave_ID,CaveName,Species_references_spread, Species,sep = ";",remove = F) %>% mutate(duplicates=duplicated(merged)) %>% mutate(duplicatesLast=duplicated(merged,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE")))

which(duplicated(Cave_Fauna_of_Greece_Census_LONG_small2))

#write_delim(dd,"lindberg1955.txt", delim = "\t",col_names = T)

species_of_Beron <- Cave_Fauna_of_Greece_Census_LONG %>% filter(Species_references_spread=="Beron 2016" & species_epithet!="sp.") %>% distinct(Species,CaveName, Cave_ID) #, CaveName, Cave_ID,NearestVillage,Municipality

```

```{r,warning=FALSE, message=FALSE, echo=FALSE,eval=FALSE}
## Create the new file Census with new references
## old file

old_references_used <- read_csv(file = "Old_files_database/Cave_Fauna_References28_08_2017.csv",col_names = T) %>% inner_join(.,species_references_spreaded_unique ,by=c("Identifier"="Reference_spread")) %>% left_join(.,species_references, by=c("Title"="Title")) %>% mutate(Author.x2=gsub(replacement = ",",";",Author.x)) %>% dplyr::select(Identifier, Author.x,Author.x2,Author.y,Year.x,Year.y,Title,Journal.x,Journal.y,Pages.x,Pages.y,Id,short_reference_ready)

old_references_used_dictionary <- old_references_used %>% dplyr::select(Identifier,short_reference_ready)

species_references_spreaded_new <- species_references_spreaded %>% left_join(., old_references_used_dictionary, by=c("Reference_spread"="Identifier"))

species_references_new_reference <- species_references_spreaded_new %>% group_by(Species,CaveName,NearestVillage,Cave_Comment,Number_references) %>% summarise(Species_references=paste0(short_reference_ready,collapse = ";"))

### New species occurencies file


species_occurencies_new <- species_occurencies %>% left_join(., species_references_new_reference)

#write_excel_csv(species_occurencies_new,path = "Cencus_Cave_fauna_of_Greece_v31_13_11_2017.txt")
```


There are `r sum(is.na(species_references$Year))` with no year data. In species occurences`r length(unique(species_references_spreaded$Reference_spread))` references where used from a total of `r length(unique(species_references$Identifier))` references. 

* Publications over time.

In the database the references will have the following format: 

Journals

Author. Year. Title. Journal, Volume (Number): Pages.

Books

Author. Year. Booktitle. Publisher. Pages.


# Data analysis and visualisation
## Caves and species bar plots

```{r, warning=FALSE, message=FALSE, echo=FALSE}

ggplot()+
  geom_col(data = caves_Region, aes(x=Region, y= number_of_caves, fill=Region),show.legend = F)+
  geom_text(data = caves_Region,aes(x =Region,y= number_of_caves, label=number_of_caves), position=position_dodge(width=0.7), vjust=-0.25,size=2.8)+
  scale_y_continuous(breaks = seq(0,200,50),limits = c(0,200))+
  #ggtitle("Caves Greece")+
  labs(x="Administrative Region", y= "Number of caves")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1))


ggsave("caves_Region_barplot.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")


```


```{r, warning=FALSE, message=FALSE, echo=FALSE}

ggplot()+
  geom_col(data = species_class, aes(x=Class, y= number_of_species, fill=Class),show.legend = F)+
  geom_text(data = species_class,aes(x =Class,y= number_of_species, label=number_of_species), position=position_dodge(width=0.7), vjust=-0.25,size=2.8)+
  scale_y_continuous(breaks = seq(0,300,50),limits = c(0,300))+
  #ggtitle("Inferring methods of the Sign Score of the PPI network of Drosophila gene")+
  labs(x="Class", y= "Number of species")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("species_class_barplot.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")


```


* bar plots with Arachnida, Insecta, Malacostrata orders

```{r, warning=FALSE, message=FALSE, echo=FALSE,fig.height=15,fig.width=10}

most_abudant_classes <- species_occurencies_unique_species %>% filter(Class=="Arachnida" | Class=="Insecta" | Class=="Malacostraca") %>% group_by(Class,Order) %>% summarise(number_of_species=n())

ggplot()+
  geom_col(data = most_abudant_classes, aes(x=Order, y= number_of_species, fill=Order),show.legend = F)+
  geom_text(data = most_abudant_classes,aes(x =Order,y= number_of_species, label=number_of_species), position=position_dodge(width=0.7), vjust=-0.25,size=2.8)+
  scale_y_continuous(breaks = seq(0,200,50),limits = c(0,200))+
  #ggtitle("Inferring methods of the Sign Score of the PPI network of Drosophila gene")+
  labs(x="Order", y= "Number of species")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap(~ Class,scales = "free", ncol=1)
  

ggsave("most_abudant_classes.jpeg", plot = last_plot(), width = 15,height = 20,units = "cm",device = "jpeg", dpi = 300,path = "Plots/")


```

## Taxon Occurencies Distribution

* Species, Genera, Families abudance in caves of Greece

```{r, warning=FALSE, message=FALSE, echo=FALSE}

# Species occurencies distributions
species_occurencies_caves <- species_occurencies %>% group_by(Species) %>% filter(species_epithet!="sp.")%>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Species")

dist_species_occurencies_caves <- ggplot(data=species_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="dodgerblue2",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="dodgerblue2",show.legend = F, size=1)+
  ggtitle("Species")+
  scale_y_continuous(breaks = seq(0,600,100),limits = c(0,600))+
  scale_x_continuous(breaks = seq(0,90,10), limits = c(0,90))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Genera occurencies distributions
genera_occurencies_caves <- species_occurencies %>% group_by(Genus) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Genus")

dist_genera_occurencies_caves <-  ggplot(data=genera_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="orange",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="orange",show.legend = F, size=1)+
  ggtitle("Genus")+
  scale_y_continuous(breaks = seq(0,210,50),limits = c(0,210))+
  scale_x_continuous(breaks = seq(0,210,50), limits = c(0,210))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Family occurencies distribution

family_occurencies_caves <- species_occurencies %>% group_by(Family) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Family")

dist_family_occurencies_caves <- ggplot(data=family_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="turquoise",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="turquoise",show.legend = F, size=1)+
  ggtitle("Family")+
  scale_x_continuous(breaks = seq(0,250,50),limits = c(0,250))+
  scale_y_continuous(breaks = seq(0,90,20), limits = c(0,90))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Order occurencies distributions

order_occurencies_caves <- species_occurencies %>% group_by(Order) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Order")

dist_order_occurencies_caves <- ggplot(data=order_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="purple",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="purple",show.legend = F, size=1)+
  ggtitle("Order")+
  scale_x_continuous(breaks = seq(0,600,100),limits = c(0,600))+
  scale_y_continuous(breaks = seq(0,20,5), limits = c(0,20))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))


## Class occurencies
class_occurencies_caves <- species_occurencies %>% group_by(Class) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Class")

dist_class_occurencies_caves <- ggplot(data=class_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="red",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="red",show.legend = F, size=1)+
  ggtitle("Class")+
  scale_y_continuous(breaks = seq(0,5,1),limits = c(0,4))+
  scale_x_continuous(breaks = seq(0,900,150), limits = c(0,900))+
  labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

## Merge distributions

occurences_taxa <- do.call("rbind",list(species_occurencies_caves,genera_occurencies_caves,family_occurencies_caves,order_occurencies_caves,class_occurencies_caves))


 ### Arrange plots
distributions_occurences_taxa <- grid.arrange(dist_species_occurencies_caves,arrangeGrob(dist_genera_occurencies_caves,dist_family_occurencies_caves,dist_order_occurencies_caves,dist_class_occurencies_caves,ncol=2),nrow = 2,bottom=textGrob("Number of occurencies in caves", gp=gpar(fontface="plain", col="black", fontsize=11)),left=textGrob("Number of taxa", gp=gpar(fontface="plain", col="black",fontsize=11), rot=90), heights=c(0.35,0.65))


ggsave("distributions_distributions_occurences_taxa.jpeg", plot = distributions_occurences_taxa, device = "jpeg",width = 13,height = 18,units = "cm", dpi = 300,path = "Plots/")

```

Without chiroptera

```{r, warning=FALSE, message=FALSE, echo=FALSE}

species_occurencies_no_chiroptera <- species_occurencies %>% filter(Order!="Chiroptera",species_epithet!="sp.")

# Species occurencies distributions
species_occurencies_caves <- species_occurencies_no_chiroptera %>% group_by(Species) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Species")

dist_species_occurencies_caves <- ggplot(data=species_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="dodgerblue2",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="dodgerblue2",show.legend = F, size=1)+
  ggtitle("Species")+
  scale_y_continuous(breaks = seq(0,600,100),limits = c(0,600))+
  scale_x_continuous(breaks = seq(0,50,5), limits = c(0,50))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Genera occurencies distributions
genera_occurencies_caves <- species_occurencies_no_chiroptera %>% group_by(Genus) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Genus")

dist_genera_occurencies_caves <-  ggplot(data=genera_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="orange",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="orange",show.legend = F, size=1)+
  ggtitle("Genus")+
  scale_y_continuous(breaks = seq(0,210,50),limits = c(0,210))+
  scale_x_continuous(breaks = seq(0,210,25), limits = c(0,150))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Family occurencies distribution

family_occurencies_caves <- species_occurencies_no_chiroptera %>% group_by(Family) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Family")

dist_family_occurencies_caves <- ggplot(data=family_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="turquoise",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="turquoise",show.legend = F, size=1)+
  ggtitle("Family")+
  scale_x_continuous(breaks = seq(0,150,25),limits = c(0,150))+
  scale_y_continuous(breaks = seq(0,90,20), limits = c(0,90))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Order occurencies distributions

order_occurencies_caves <- species_occurencies_no_chiroptera %>% group_by(Order) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Order")

dist_order_occurencies_caves <- ggplot(data=order_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="purple",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="purple",show.legend = F, size=1)+
  ggtitle("Order")+
  scale_x_continuous(breaks = seq(0,600,100),limits = c(0,600))+
  scale_y_continuous(breaks = seq(0,20,5), limits = c(0,20))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))


## Class occurencies
class_occurencies_caves <- species_occurencies_no_chiroptera %>% group_by(Class) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Class")

dist_class_occurencies_caves <- ggplot(data=class_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="red",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="red",show.legend = F, size=1)+
  ggtitle("Class")+
  scale_y_continuous(breaks = seq(0,5,1),limits = c(0,4))+
  scale_x_continuous(breaks = seq(0,900,150), limits = c(0,900))+
  labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

## Merge distributions

occurences_taxa <- do.call("rbind",list(species_occurencies_caves,genera_occurencies_caves,family_occurencies_caves,order_occurencies_caves,class_occurencies_caves))


 ### Arrange plots
distributions_occurences_taxa <- grid.arrange(dist_species_occurencies_caves,arrangeGrob(dist_genera_occurencies_caves,dist_family_occurencies_caves,dist_order_occurencies_caves,dist_class_occurencies_caves,ncol=2),nrow = 2,bottom=textGrob("Number of occurencies in caves", gp=gpar(fontface="plain", col="black", fontsize=11)),left=textGrob("Number of taxa (no chiroptera)", gp=gpar(fontface="plain", col="black",fontsize=11), rot=90), heights=c(0.35,0.65))


ggsave("distributions_distributions_occurences_taxa_no_chiroptera.jpeg", plot = distributions_occurences_taxa, device = "jpeg",width = 13,height = 18,units = "cm", dpi = 300,path = "Plots/")

```

Only chiroptera

```{r, warning=FALSE, message=FALSE, echo=FALSE}

species_occurencies_only_chiroptera <- species_occurencies %>% filter(Order=="Chiroptera", species_epithet!="sp.")
species_occurencies_only_chiroptera2 <- species_occurencies_only_chiroptera %>% dplyr::select(Order,Family,Genus,Species) %>% distinct()

# Species occurencies distributions
species_occurencies_caves <- species_occurencies_only_chiroptera %>% group_by(Species) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Species")

dist_species_occurencies_caves <- ggplot(data=species_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="dodgerblue2",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="dodgerblue2",show.legend = F, size=1)+
  ggtitle("Species")+
  #scale_y_continuous(breaks = seq(0,600,100),limits = c(0,600))+
  scale_x_continuous(breaks = seq(0,50,5), limits = c(0,50))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Genera occurencies distributions
genera_occurencies_caves <- species_occurencies_only_chiroptera %>% group_by(Genus) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Genus")

dist_genera_occurencies_caves <-  ggplot(data=genera_occurencies_caves)+
  geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="orange",show.legend = F)+
  geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="orange",show.legend = F, size=1)+
  ggtitle("Genus")+
  scale_y_continuous(breaks = seq(0,3,1),limits = c(0,3))+
  scale_x_continuous(breaks = seq(0,210,25), limits = c(0,150))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Family occurencies distribution

family_occurencies_caves <- species_occurencies_only_chiroptera %>% group_by(Family) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Family")

# dist_family_occurencies_caves <- ggplot(data=family_occurencies_caves)+
#   geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="turquoise",show.legend = F)+
#   geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="turquoise",show.legend = F, size=1)+
#   ggtitle("Family")+
#   scale_x_continuous(breaks = seq(0,150,25),limits = c(0,150))+
#   scale_y_continuous(breaks = seq(0,90,20), limits = c(0,90))+
#   #labs(x="Number of species", y= "Number of taxa")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

# Order occurencies distributions

order_occurencies_caves <- species_occurencies_only_chiroptera %>% group_by(Order) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Order")

# dist_order_occurencies_caves <- ggplot(data=order_occurencies_caves)+
#   geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="purple",show.legend = F)+
#   geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="purple",show.legend = F, size=1)+
#   ggtitle("Order")+
#   scale_x_continuous(breaks = seq(0,600,100),limits = c(0,600))+
#   scale_y_continuous(breaks = seq(0,20,5), limits = c(0,20))+
#   #labs(x="Number of species", y= "Number of taxa")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))


## Class occurencies
class_occurencies_caves <- species_occurencies_only_chiroptera %>% group_by(Class) %>% summarise(taxon_occurences=n()) %>% group_by(taxon_occurences) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Class")

# dist_class_occurencies_caves <- ggplot(data=class_occurencies_caves)+
#   geom_line(aes(x=taxon_occurences, y= number_of_taxon),color="red",show.legend = F)+
#   geom_point(aes(x=taxon_occurences, y= number_of_taxon),color="red",show.legend = F, size=1)+
#   ggtitle("Class")+
#   scale_y_continuous(breaks = seq(0,5,1),limits = c(0,4))+
#   scale_x_continuous(breaks = seq(0,900,150), limits = c(0,900))+
#   labs(x="Number of species", y= "Number of taxa")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

## Merge distributions

occurences_taxa <- do.call("rbind",list(species_occurencies_caves,genera_occurencies_caves,family_occurencies_caves,order_occurencies_caves,class_occurencies_caves))


 ### Arrange plots
distributions_occurences_taxa <- grid.arrange(dist_species_occurencies_caves,dist_genera_occurencies_caves,nrow = 2,bottom=textGrob("Number of occurencies in caves", gp=gpar(fontface="plain", col="black", fontsize=11)),left=textGrob("Number of taxa (only chiroptera)", gp=gpar(fontface="plain", col="black",fontsize=11), rot=90), heights=c(0.35,0.65))


ggsave("distributions_distributions_occurences_taxa_only_chiroptera.jpeg", plot = distributions_occurences_taxa, device = "jpeg",width = 13,height = 18,units = "cm", dpi = 300,path = "Plots/")

```

## Taxon - Subtaxon Distribution


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Genus
species_occurencies_unique_species_genus_dist <- species_occurencies_unique_species %>% dplyr::select(Species,Genus) %>% distinct() %>% group_by(Genus) %>% summarise(number_of_species=n()) %>% group_by(number_of_species) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Genus")

# Family
species_occurencies_unique_species_Family_dist <- species_occurencies_unique_species %>% dplyr::select(Species,Family) %>% distinct() %>% group_by(Family) %>% summarise(number_of_species=n()) %>% group_by(number_of_species) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Family")

# Order
species_occurencies_unique_species_Order_dist <- species_occurencies_unique_species %>% dplyr::select(Species,Order) %>% distinct() %>% group_by(Order) %>% summarise(number_of_species=n()) %>% group_by(number_of_species) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Order")

# Class
species_occurencies_unique_species_Class_dist <- species_occurencies_unique_species %>% dplyr::select(Species,Class) %>% distinct() %>% group_by(Class) %>% summarise(number_of_species=n()) %>% group_by(number_of_species) %>% summarise(number_of_taxon=n()) %>% mutate(taxon="Class")

species_taxon_distributions <- do.call("rbind", list(species_occurencies_unique_species_genus_dist, species_occurencies_unique_species_Family_dist, species_occurencies_unique_species_Order_dist,species_occurencies_unique_species_Class_dist))


ggplot()+
  geom_point(data = species_taxon_distributions, aes(x=number_of_species, y= number_of_taxon, color=taxon),show.legend = T)+
  #ggtitle("Inferring methods of the Sign Score of the PPI network of Drosophila gene")+
  scale_y_continuous(breaks = seq(0,320,20),limits = c(0,320))+
  scale_x_continuous(breaks = seq(0,280,20),limits = c(0,280))+
  labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())
ggsave("species_taxon_distributions_plot.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")

```

```{r, warning=FALSE, message=FALSE, echo=FALSE}

dist_class <- species_taxon_distributions %>% filter(taxon=="Class") %>% 
  ggplot(data=.)+
  geom_line(aes(x=number_of_species, y= number_of_taxon),color="red",show.legend = F)+
  geom_point(aes(x=number_of_species, y= number_of_taxon),color="red",show.legend = F, size=1)+
  ggtitle("Class")+
  scale_y_continuous(breaks = seq(0,5,1),limits = c(0,4))+
  scale_x_continuous(breaks = seq(0,300,50), limits = c(0,300))+
  labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

dist_order <- species_taxon_distributions %>% filter(taxon=="Order") %>% 
  ggplot(data=.)+
  geom_line(aes(x=number_of_species, y= number_of_taxon),color="purple",show.legend = F)+
  geom_point(aes(x=number_of_species, y= number_of_taxon),color="purple",show.legend = F, size=1)+
  ggtitle("Order")+
  scale_y_continuous(breaks = seq(0,20,5),limits = c(0,20))+
  scale_x_continuous(breaks = seq(0,180,20), limits = c(0,180))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

dist_family <- species_taxon_distributions %>% filter(taxon=="Family") %>% 
  ggplot(data=.)+
  geom_line(aes(x=number_of_species, y= number_of_taxon),color="turquoise",show.legend = F)+
  geom_point(aes(x=number_of_species, y= number_of_taxon),color="turquoise",show.legend = F, size=1)+
  ggtitle("Family")+
  scale_y_continuous(breaks = seq(0,120,20),limits = c(0,120))+
  scale_x_continuous(breaks = seq(0,80,10), limits = c(0,70))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

dist_genus <- species_taxon_distributions %>% filter(taxon=="Genus") %>% 
  ggplot(data=.)+
  geom_line(aes(x=number_of_species, y= number_of_taxon),color="orange",show.legend = F)+
  geom_point(aes(x=number_of_species, y= number_of_taxon),color="orange",show.legend = F, size=1)+
  ggtitle("Genus")+
  scale_y_continuous(breaks = seq(0,300,50),limits = c(0,300))+
  scale_x_continuous(breaks = seq(0,30,5), limits = c(0,30))+
  #labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),plot.title = element_text(hjust = 0.5, size = 11))

distributions_species_taxon <- grid.arrange(arrangeGrob(grobs = list(dist_class,dist_order,dist_family,dist_genus)), ncol=2,bottom=textGrob("Number of species", gp=gpar(fontface="plain", col="black", fontsize=11)), left=textGrob("Number of taxa", gp=gpar(fontface="plain", col="black",fontsize=11), rot=90),widths=c(9,0.5))


ggsave("distributions_species_taxon.jpeg", plot = distributions_species_taxon, device = "jpeg", dpi = 300,path = "Plots/")


```

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
#determine order of appearance in facet_wrap

species_taxon_distributions$taxon_order <- factor(species_taxon_distributions$taxon, levels = c("Class","Order","Family","Genus"))

ggplot()+
  geom_line(data = species_taxon_distributions, aes(x=number_of_species, y= number_of_taxon,colour = factor(taxon)),show.legend = F)+
  geom_point(data = species_taxon_distributions, aes(x=number_of_species, y= number_of_taxon,colour = factor(taxon)),show.legend = F, size=1)+
  #ggtitle("Inferring methods of the Sign Score of the PPI network of Drosophila gene")+
  #scale_y_continuous(breaks = )+
  #scale_x_continuous(breaks = seq(0,280,20))+
  labs(x="Number of species", y= "Number of taxa")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())+
  facet_wrap( ~ taxon_order,scales = "free")

ggsave("species_taxon_distributions_plot_facet.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")
```

## Species References
```{r,warning=FALSE, message=FALSE, echo=FALSE}

species_references_year_dist <- species_references %>% group_by(Year) %>% summarise(publications_per_year=n())


ggplot()+
  geom_line(data=species_references_year_dist,aes(x=Year, y= publications_per_year),color="red",show.legend = F)+
  scale_x_continuous(breaks = seq(1860,2020,10),limits = c(1860,2020))+
  scale_y_continuous(breaks = seq(0,20,2), limits = c(0,20))+
  labs(x="Years",y="Number of new publications")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggsave("species_references_year_dist.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")

```

```{r,warning=FALSE, message=FALSE, echo=FALSE}

species_references_year_dist$Cumulative_publications <- cumsum(species_references_year_dist$publications_per_year)

ggplot(data=species_references_year_dist)+
  geom_line(aes(x=Year, y= Cumulative_publications),color="mediumseagreen",show.legend = F)+
  #ggtitle("Class")+
  scale_x_continuous(breaks = seq(1860,2020,10),limits = c(1860,2020))+
  scale_y_continuous(breaks = seq(0,750,100), limits = c(0,750))+
  labs(x="Years",y="Number of publications")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggsave("species_references_year_dist_cumulative.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")

```


* New species discovered in time. (references)

```{r,warning=FALSE, message=FALSE, echo=FALSE}
####
# species_references_spreaded2 <- species_references_spreaded %>% left_join(.,species_occurencies_unique_species,by=c("Species"="Species")) %>% left_join(.,species_references, by=c("Species_references_spread"="short_reference_ready")) %>% left_join(.,species_occurencies_unique_caves, by=c("CaveName"="CaveName" , "NearestVillage"="NearestVillage","Cave_ID"="Cave_ID"))
# 


species_references_spreaded_arranged <- Cave_Fauna_of_Greece_Census_LONG %>% ungroup() %>% dplyr::select(Species, Species_references_spread, Year) %>% group_by(Species,Species_references_spread, Year) %>% distinct(.) %>% arrange(.,Year) %>% ungroup() %>% mutate(Duplicates=duplicated(Species)) %>% mutate(.,First_occurance=if_else(Duplicates=="FALSE",1,0)) %>% na.omit()

species_references_spreaded_arranged$Cumulative_occurance <- cumsum(species_references_spreaded_arranged$First_occurance)

ggplot(data=species_references_spreaded_arranged)+
  geom_line(aes(x=Year, y= Cumulative_occurance),color="violetred1",show.legend = F)+
  #ggtitle("Class")+
  scale_x_continuous(breaks = seq(1860,2020,10),limits = c(1860,2020))+
  scale_y_continuous(breaks = seq(0,950,100), limits = c(0,950))+
  labs(x="Years",y="Number of new species in Greek caves")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggsave("species_occurence_accumulation.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")

```


```{r,warning=FALSE, message=FALSE, echo=FALSE}

species_references_spreaded_arranged_article <- species_references_spreaded_arranged %>% filter(Duplicates=="FALSE") %>% group_by(Species_references_spread, Year) %>% summarise(n_new_species=n()) %>% group_by(n_new_species) %>% summarise(n_references=n())

ggplot()+
  geom_line(data=species_references_spreaded_arranged_article,aes(y=n_references, x= n_new_species),color="violetred1",show.legend = F)+
  #ggtitle("Class")+
  scale_x_continuous(breaks = seq(0,180,20),limits = c(0,180))+
  scale_y_continuous(breaks = seq(0,180,20),limits = c(0,180))+
  labs(x="Number of references",y="Number of new species in Greek caves")+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())

ggsave("species_references_spreaded_arranged_article.jpeg", plot = last_plot(), device = "jpeg", dpi = 300,path = "Plots/")

```

# Spatial analysis of Caves

For the creation of the caves geodatabase in r we used multiple packages. 

**For spatial analysis**

1. sp package [@R-sp]

2. rgeos package [@R-rgeos]

3. rgdal package [@R-raster]

4. raster package [@R-raster]

**For spatial visualisations**

1. maptools package [@R-maptools]

2. tmaps package [@R-tmap]

3. ggmap package [@R-ggmap]


Each cave location wes manually imported to Google Earth. All locations were then exported to a single kml file. In order to handle the data the kml file should be converted to a different format like xlsx. The procedure suggested from google forum:

1. Download the kml file
2. rename the file to .xml 
3. from excel 2007 go to Data > From Other Sources > From XML Data Source 
4. Browse to where you saved the file to impoort into excel. 
5. Excel will prompt that it can find the schema and will try to make it by it's own, accept it and you should see your data imported successfully.

This procedure resulted to a xlsx file with 67 columns and tha names and coordinates of caves were spread across them for some reason.

So we used the [online convertor](www.gpsvisualizer.com) which resulted to a txt file with a consistent format.


## Caves geographical data

```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Caves shape file! Caves Coordinates

# Caves_Database_kml_to_txt <- read_delim(file = "Caves_Database_kml_to_txt_25_09_2017.csv",delim = ";",col_names = T) %>% dplyr::select("name","latitude","longitude")

Caves_Database_kml_to_txt <- species_occurencies_unique_caves %>% dplyr::select(CaveName,Cave_ID,Latitude, Longitude) %>% na.omit()

Caves_Database_kml_to_txt$Latitude <- as.numeric(Caves_Database_kml_to_txt$Latitude)
Caves_Database_kml_to_txt$Longitude <- as.numeric(Caves_Database_kml_to_txt$Longitude)

Caves_Database_kml_to_txt$ID <- as.character(seq(1:nrow(Caves_Database_kml_to_txt)))

Caves_Database_kml_to_txt_shapefile <- Caves_Database_kml_to_txt

coordinates(Caves_Database_kml_to_txt_shapefile)<-~Longitude+Latitude
proj4string(Caves_Database_kml_to_txt_shapefile) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84


species_occurencies_unique_caves_without <- species_occurencies_unique_caves[which((is.na(species_occurencies_unique_caves$Latitude))),]

```

Are the cave names in the species occurencies file the same with the Google Earth data?

There are `r nrow(species_occurencies_unique_caves)` caves that have been sampled.

## Administrative data of Greece

We downloaded the greek municipality boundaries (Kallikratis plan) from [http://geodata.gov.gr/en/dataset/oria-demon-kallikrates](http://geodata.gov.gr) in the epsg 4326 format. In this format the axis order is Latitude followed by Longitude. 
The Greek names of municipalities were converted using the ISO 843 traslitaration system from this [online portal](http://www.passport.gov.gr/elot-743.html).

It is preferable to download shapefiles because they are immediatly imported into the Spatial objects. 


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Hellenic settlements 

hellenic_settlements <- maptools::readShapePoints("hellenic_settlements/hellenic_settlements",verbose=TRUE)
proj4string(hellenic_settlements) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84

# Municipalities shape file


municipalities_shape_file <- maptools::readShapePoly("municipalities_shape_file/municipalities_Kallikratis_plan_Greece",verbose=TRUE)
proj4string(municipalities_shape_file) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84

municipalities_greece_long_names_eng <- read_xlsx("municipalities_shape_file/names_municipalities_gr_eng.xlsx",col_names = T)
municipalities_greece_long_names_eng$KWD_YPES <- as.character(municipalities_greece_long_names_eng$KWD_YPES)

municipalities_shape_file@data <- municipalities_shape_file@data %>% left_join(., municipalities_greece_long_names_eng, by=c("KWD_YPES"="KWD_YPES"))
rownames(municipalities_shape_file@data) <- as.character(seq(1:nrow(municipalities_shape_file@data)))


over_municipality <- sp::over( x = Caves_Database_kml_to_txt_shapefile , y = municipalities_shape_file , fn = NULL)

caves_in_municipa <- over_municipality

caves_in_municipa$ID <- as.character(seq(1:nrow(caves_in_municipa)))

caves_in_municipa2 <- caves_in_municipa %>% left_join(., Caves_Database_kml_to_txt, by=c("ID"="ID"))



#combine previous file with the caves from occurence data

# species_occurencies_unique_caves$joined <- do.call(paste, c(species_occurencies_unique_caves[c("CaveName", "Municipality")], sep = ";"))
# 
# species_occurencies_unique_caves <- species_occurencies_unique_caves %>% left_join(., caves_in_municipa2, by=c("joined"="joined")) %>% dplyr::select(-V2,-name,-V3,-joined)
# 
# species_occurencies_unique_caves_coords <- species_occurencies_unique_caves %>% filter(!is.na(Cave_ID))
# 
# species_occurencies_unique_caves_coords_dataframe <- species_occurencies_unique_caves_coords

```



```{r, warning=FALSE, message=FALSE, echo=FALSE,eval=TRUE}

caves_municipality_join <- caves_municipality %>% left_join(.,municipalities_greece_long_names_eng, by=c("Municipality"="Municipalities_ISO_843"),copy=TRUE) %>% left_join(.,municipalities_greece_long_names_eng, by=c("KWD_YPES"="KWD_YPES"),copy=TRUE) %>% dplyr::select(Municipalities_ISO_843,KWD_YPES,number_of_caves) %>% ungroup() %>% filter(!(KWD_YPES=="9170" & !is.na(KWD_YPES)))

# Irakleio is 2 times but they are different municipalities. Irakleio Attikis has 9170 code so we removed it.

caves_species_municipality_join <-  caves_municipality_join %>% left_join(.,species_municipality, by=c("Municipalities_ISO_843"="Municipality"))


```


## Protected areas of Greece

```{r, warning=FALSE, message=FALSE, echo=FALSE}


natura2000_NEW_shapefile <- maptools::readShapePoly("Natura2000_2017_NEW_shp/Kaloust/Nees_Natura", verbose = TRUE)

natura2000_NEW_shapefile_INFO <- maptools::readShapePoly("Natura2000_2017_NEW_shp/NEES_FINAL_V10", verbose = TRUE)

natura2000_NEW_shapefile_INFO_df <- natura2000_NEW_shapefile_INFO@data %>% mutate(id=as.character(seq(from=0,to=(nrow(.)-1))))

natura2000_NEW_shapefile@data <-  natura2000_NEW_shapefile@data %>% mutate(id=as.character(seq(from=0,to=(nrow(.)-1)))) %>% left_join(natura2000_NEW_shapefile_INFO_df, by=c("id"="id")) %>% dplyr::select(-c(descriptio,timestamp,begin,end,altitudeMo,tessellate,extrude,visibility,drawOrder,icon))

proj4string(natura2000_NEW_shapefile) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") # this is WGS84


##### Natura 2000
natura2000shapefile <- maptools::readShapePoly("natura2000shapefile/natura2000shapefile",verbose=TRUE)

proj4string(natura2000shapefile) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84

natura2000shapefile_data <- natura2000shapefile@data %>% dplyr::select(CODE,NAME_LATIN)
### Katafygia agrias zois
#katafygia_agrias_zwhs <- maptools::readShapePoly("katafygia_agrias_zwhs/katafygia_agrias_zwhs",verbose=TRUE)

#proj4string(katafygia_agrias_zwhs) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84

####
katafygia_agrias_zwhs <- maptools::readShapePoly("KAZ_data/KAZ_data",verbose=TRUE)

proj4string(katafygia_agrias_zwhs) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84

#ssss <- katafygia_agrias_zwhs@data

KAZ_data_translated <- read_xlsx("KAZ_data/KAZ_table_translated.xlsx",col_names = T)

KAZ_data_KODE <- read_csv("KAZ_data/KAZ_data.csv",col_names = T) %>% dplyr::select(-the_geom) %>% left_join(KAZ_data_translated, by=c("KODE"="KODE"))

### New Natura Over
over_NEW_natura <- sp::over( x = Caves_Database_kml_to_txt_shapefile, y = natura2000_NEW_shapefile , fn = NULL)

caves_in_over_NEW_natura <- over_NEW_natura %>% mutate(ID=as.character(seq(1:nrow(over_NEW_natura)))) %>% filter(SITE_TYPE=="SCI") %>% mutate(TYPE=gsub(pattern = "TROP",replacement = "Modified:",x =TYPE),Name_New_NATURA2=gsub(pattern = "TROP ",replacement = "",x = Name)) %>% left_join(Caves_Database_kml_to_txt,by=c("ID"="ID")) %>% dplyr::select(Cave_ID,TYPE,SITE_TYPE,Name_New_NATURA2) %>% left_join(natura2000shapefile_data, by=c("Name_New_NATURA2"="CODE")) %>% dplyr::select(-c(Name_New_NATURA2))

colnames(caves_in_over_NEW_natura) <- c("Cave_ID","CODE_NEW_NATURA","SITETYPE_NEW_NATURA", "NAME_LATIN_NEW_NATURA")

### over NATURA

over_natura <- sp::over( x = Caves_Database_kml_to_txt_shapefile , y = natura2000shapefile , fn = NULL)

# create file with the old and new natura2000 areas combined

caves_in_over_natura <- over_natura %>% mutate(ID=as.character(seq(1:nrow(over_natura)))) %>% left_join(Caves_Database_kml_to_txt,by=c("ID"="ID")) %>% dplyr::select(Cave_ID,CODE,SITETYPE,NAME_LATIN)

colnames(caves_in_over_natura) <- c("Cave_ID","CODE_NATURA","SITETYPE_NATURA", "NAME_LATIN_NATURA")

### over Katafygia agrias zwis

over_katafygia_agrias_zwhs <- sp::over( x = Caves_Database_kml_to_txt_shapefile , y = katafygia_agrias_zwhs , fn = NULL)

over_katafygia_agrias_zwhs$ID_cave <- as.character(seq(1:nrow(over_katafygia_agrias_zwhs)))

over_katafygia_agrias_zwhs_info <- over_katafygia_agrias_zwhs %>% dplyr::select(KODE,ID_cave) %>% left_join(KAZ_data_KODE, by=c("KODE"="KODE"))

caves_in_over_katafygia_agrias_zwhs <- Caves_Database_kml_to_txt %>% left_join(over_katafygia_agrias_zwhs_info,by=c("ID"="ID_cave")) %>% dplyr::select(Cave_ID,KODE,KAZ_NAME_GR,KAZ_Official_Government_Gazette)

### caves with all protected areas
capwords <- function(s, strict = FALSE) {
    cap <- function(s) paste(toupper(substring(s, 1, 1)),
                  {s <- substring(s, 2); if(strict) tolower(s) else s},
                             sep = "", collapse = " " )
    sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}

caves_protection <- species_occurencies_unique_caves %>% dplyr::select(Cave_ID) %>% left_join(.,caves_in_over_natura, by=c("Cave_ID"="Cave_ID")) %>% left_join(.,caves_in_over_NEW_natura, by=c("Cave_ID"="Cave_ID")) %>% left_join(., caves_in_over_katafygia_agrias_zwhs, by=c("Cave_ID"="Cave_ID")) %>% mutate(NAME_LATIN_NATURA=gsub("NANA",NA_character_,gsub(" Kai "," and ",capwords(tolower(NAME_LATIN_NATURA))))) %>% mutate(NAME_LATIN_NEW_NATURA=gsub("NANA",NA_character_,gsub(" Kai "," and ",capwords(tolower(NAME_LATIN_NEW_NATURA))))) %>% mutate(SITETYPE_NATURA_ALL=ifelse(is.na(SITETYPE_NATURA), NA_character_, ifelse(SITETYPE_NATURA=="SPA","Special Protection Area", ifelse(SITETYPE_NATURA=="SCI","Special Area of Conservation ", "Special Protection Area - Special Area of Conservation"))),SITETYPE_NEW_NATURA_ALL=ifelse(is.na(SITETYPE_NEW_NATURA), NA_character_, ifelse(SITETYPE_NEW_NATURA=="SPA","Special Protection Area", ifelse(SITETYPE_NEW_NATURA=="SCI","Special Area of Conservation ", "Special Protection Area - Special Area of Conservation"))))

## some names in () had lower case first letters so i changed them manually.
#write_delim(caves_protection,path = "caves_protection.txt",delim = "\t",col_names = T)


caves_protectionxlsx <- read_xlsx("caves_protection.xlsx",col_names = T) 

caves_protectionxlsx[caves_protectionxlsx=="NA"] <- NA

caves_protectionxlsx2 <- caves_protectionxlsx %>% mutate(LEGISLATION_NATURA=if_else(is.na(NAME_LATIN_NATURA) & is.na(NAME_LATIN_NEW_NATURA),NA_character_,"Law 3937/2011 (OGG/Α 60/31.03.2011), Joint Ministerial Decision 50743/2017 (OGG 4432/B/15.12.17"))


species_occurencies2 <- species_occurencies %>% mutate(qqq=paste(Species,Cave_ID,CaveName,Species_references,sep = ";")) %>% mutate(duplicates=duplicated(qqq)) %>% mutate(duplicatesLast=duplicated(qqq,fromLast = T)) %>% mutate(duplicatesAll=if_else(duplicates=="TRUE","TRUE",if_else(duplicatesLast=="TRUE","TRUE","FALSE"))) %>% filter(duplicatesLast!="TRUE") %>% dplyr::select(-c(qqq,duplicates,duplicatesAll,duplicatesLast,ID,     objectid_NATURA,CODE_NATURA,area_NATURA,perimeter_NATURA,hectares_NATURA,SITETYPE_NATURA,                PERIPHERY_NATURA,PREFECTURE_NATURA,NAME_LATIN_NATURA,area_katafygia_agrias_zwhs,        FID_katafygia_agrias_zwhs,THESH_katafygia_agrias_zwhs,PERIFEREIA_katafygia_agrias_zwhs,   EPOPTEYOYS_katafygia_agrias_zwhs,DHMOS_KOIN_katafygia_agrias_zwhs,NOMOS_katafygia_agrias_zwhs,           EKTASH_katafygia_agrias_zwhs,APOFASH_katafygia_agrias_zwhs,FEK_katafygia_agrias_zwhs,EIDH_CHLOR_katafygia_agrias_zwhs,PANIDA_PTH_katafygia_agrias_zwhs,PANIDA_THI_katafygia_agrias_zwhs,PANIDA_PSA_katafygia_agrias_zwhs,PANIDA_ERP_katafygia_agrias_zwhs,PANIDA_AMF_katafygia_agrias_zwhs,area_strem_katafygia_agrias_zwhs,perimeter_katafygia_agrias_zwhs,CODE_SYNTO_NEW_NATURA,area_NEW_NATURA,CODE_SYN_1_New_NATURA,TYPE_NEW_NATURA,SITE_TYPE_NEW_NATURA)) %>% left_join(caves_protectionxlsx2, by=c("Cave_ID"="Cave_ID"))

#write_delim(species_occurencies2,path = "Cave_Fauna_of_Greece_Census_v5_24_01_2018.txt",delim = "\t",col_names = T)

census_for_database <- species_occurencies2 %>% dplyr::select(-c(Species_before_GNR,Species_Old,Speciment_Abbreviations,Species_comment,Synonymes,Merged,Comments,`Beron 2016`,Old_References,Number_references,References_Kaloust_old,Reference_comment,`Reference 3`,Species_Comments_2018,Species_2018,Distribution_IUCN,Countries_occurrences_GBIF,Distribution_CoT,Species_2018_2,Census_Merge,Cave_ID_OLD,Cave_comment2,NAME,KWD_YPES,Municipalities_gr_original,Municipalities_ISO_843,Municipalities_gr,CaveReferences,Cave_Comment)) %>% mutate(Locus_Typicus=if_else(is.na(Locus_Typicus),NA_character_,"Locus Typicus"))

#write_delim(census_for_database,"census_for_database_24_01_2018.txt",delim = "\t",col_names = T)

# ## NATURA TO dataframes
# 
# to_df_natura <- function(x){
#   
# y <- data.frame(Cave_ID=as.character(),NAME_LATIN_NATURA=as.character(),CODE_NATURA=as.character(),SITETYPE_NATURA=as.character(),objectid_NATURA=as.character(), stringsAsFactors=FALSE) 
# 
# for(i in 1:length(x)) {
#   
#   y[i,1] <- as.character(names(x[i]))
#   y[i,2] <- paste(as.character(x[[i]]$NAME_LATIN),collapse = ";")
#   y[i,3] <- paste(as.character(x[[i]]$CODE),collapse = ";")
#   y[i,4] <- paste(as.character(x[[i]]$SITETYPE),collapse = ";")
#   y[i,5] <- paste(as.character(x[[i]]$objectid),collapse = ";")
# }
#   y
# }
# 
# caves_in_over_natura <- to_df_natura(over_natura)
# 
# is.na(caves_in_over_natura) <- caves_in_over_natura==''

# ## KAZ TO dataframes
# 
# to_df_kaz <- function(x){
#   
# y <- data.frame(Cave_ID=as.character(),area=as.character(),area_strem=as.character(), stringsAsFactors=FALSE) 
# 
# for(i in 1:length(x)) {
#   
#   y[i,1] <- as.character(names(x[i]))
#   y[i,2] <- paste(as.character(x[[i]]$area),collapse = ";")
#   y[i,3] <- paste(as.character(x[[i]]$area_strem),collapse = ";")
#   
# }
#   y
# }
# 
# caves_in_over_katafygia_agrias_zwhs <- to_df_kaz(over_katafygia_agrias_zwhs)
# 
# is.na(caves_in_over_katafygia_agrias_zwhs) <- caves_in_over_katafygia_agrias_zwhs==''

#katafygia_agrias_zwhs_names <- read_delim(file = "katafygia_agrias_zwhs/katafygia_agrias_zwhs_names.csv", col_names=T,delim=";")

#katafygia_agrias_zwhs_names$area <- as.character(katafygia_agrias_zwhs_names$area)
# 
#caves_in_over_katafygia_agrias_zwhs$area <- as.character(caves_in_over_katafygia_agrias_zwhs$area)

#caves_in_over_katafygia_agrias_zwhs2 <- caves_in_over_katafygia_agrias_zwhs %>% left_join(.,katafygia_agrias_zwhs_names, by=c("area"="area"))

#caves_in_over_katafygia_agrias_zwhs2$ID <- as.character(seq(1:nrow(caves_in_over_katafygia_agrias_zwhs2)))

#colnames(caves_in_over_katafygia_agrias_zwhs2) <- c("area_katafygia_agrias_zwhs" ,"FID_katafygia_agrias_zwhs" ,"THESH_katafygia_agrias_zwhs", "PERIFEREIA_katafygia_agrias_zwhs"  ,"EPOPTEYOYS_katafygia_agrias_zwhs" ,"DHMOS_KOIN_katafygia_agrias_zwhs" ,"NOMOS_katafygia_agrias_zwhs","EKTASH_katafygia_agrias_zwhs","APOFASH_katafygia_agrias_zwhs" ,"FEK_katafygia_agrias_zwhs", "EIDH_CHLOR_katafygia_agrias_zwhs","PANIDA_PTH_katafygia_agrias_zwhs" ,"PANIDA_THI_katafygia_agrias_zwhs" ,"PANIDA_PSA_katafygia_agrias_zwhs","PANIDA_ERP_katafygia_agrias_zwhs", "PANIDA_AMF_katafygia_agrias_zwhs","area_strem_katafygia_agrias_zwhs", "perimeter_katafygia_agrias_zwhs","ID")

```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
# shapefiles to dataframes for plotting
## New Natura
natura2000_NEW_shapefile_names <- natura2000_NEW_shapefile@data %>% mutate(id=as.character(seq(from=0,to=(nrow(.)-1))))

natura2000_NEW_shapefile_dataframe <- tidy(natura2000_NEW_shapefile) %>% left_join(., natura2000_NEW_shapefile_names, by=c("id"="id"))

# %>% left_join(natura2000_NEW_shapefile_INFO_df, by=c("id"="id"))
# 
# %>% dplyr::select(-c(timestamp,begin,end,altitudeMo,tessellate,extrude,visibility,drawOrder,icon))


### Natura 2000
names_natura2000shapefile <- natura2000shapefile@data %>% mutate(id=as.character(seq(from=0,to=(nrow(.)-1))))

natura2000shapefile_dataframe <- tidy(natura2000shapefile) %>% left_join(., names_natura2000shapefile, by=c("id"="id"))

### katafygia_agrias_zwhs
#katafygia_agrias_zwhs_names$id <- as.character(seq(from=0,to=(nrow(katafygia_agrias_zwhs_names)-1)))

#katafygia_agrias_zwhs_dataframe <- tidy(katafygia_agrias_zwhs) %>% left_join(., katafygia_agrias_zwhs_names, by=c("id"="id"))

### caves
#caves_protected_areas <- species_occurencies_unique_caves_all_info %>% filter(!(is.na(NAME_LATIN_NATURA)) & !(is.na(area_katafygia_agrias_zwhs)))



```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
#### JOIN FILES ##########

caves_all_shapefiles <- caves_in_municipa2 %>% dplyr::select(-CaveName,-Longitude,-Latitude)%>% left_join(.,caves_in_over_natura, by=c("Cave_ID"="Cave_ID")) %>% left_join(., caves_in_over_katafygia_agrias_zwhs, by=c("Cave_ID"="Cave_ID"))

#sss <- caves_all_shapefiles[which(is.na(caves_all_shapefiles$Municipalities_ISO_843)),] %>% dplyr::select(Cave_ID) %>% left_join(species_occurencies_unique_caves, by=c("Cave_ID"="Cave_ID"))


#caves_all_shapefiles$joined <- do.call(paste, c(caves_all_shapefiles[c("name", "Municipalities_ISO_843")], sep = ";"))

#species_occurencies_unique_caves2 <- species_occurencies_unique_caves

#species_occurencies_unique_caves2$joined <- do.call(paste, c(species_occurencies_unique_caves2[c("CaveName", "Municipality")], sep = ";"))

# Caves Ready!!!

species_occurencies_unique_caves_all_info <- species_occurencies_unique_caves %>% left_join(.,caves_all_shapefiles, by=c("Cave_ID"="Cave_ID"))

#write_delim(x = species_occurencies_unique_caves_all_info,path = "Cave_Fauna_of_Greece_Caves_10_12_2017.txt",delim = "\t",col_names = T)

#species_occurencies_unique_caves3$joined <- do.call(paste, c(species_occurencies_unique_caves3[c("CaveName", "NearestVillage","Municipality", "Cave_Comment")], sep = ";"))


species_occurencies_unique_caves3 <- Caves_Database_kml_to_txt  %>% left_join(caves_in_over_NEW_natura, by=c("Cave_ID"="Cave_ID")) %>% dplyr::select(-c(CaveName,Latitude,Longitude)) %>% distinct(.)

## Species ready !!
species_occurencies_unique_species_sel <- species_occurencies_unique_species %>% dplyr::select(-c(Phylum,Class,Order,Family,Genus,species_epithet,Species_bare_name))


INSPEE_DATABASE_01_beta <- species_occurencies %>% left_join(.,species_occurencies_unique_caves3,by=c("Cave_ID"="Cave_ID"))

#write_delim(x = INSPEE_DATABASE_01_beta,path = "INSPEE_DATABASE_01_beta2_27_09_2017.txt",delim = "\t",col_names = T)

```


# Geospatial data visualisation

## Species and caves per region

```{r,eval=TRUE, cache=TRUE,warning=FALSE, message=FALSE, echo=FALSE}
greece_level_2 <-getData('GADM', country='GRC', level=2)  ##Get the Province Shapefile for France
```

```{r,warning=FALSE, message=FALSE, echo=FALSE}
greece_regions <- c("Athos","East Macedonia and Thrace","Attica ","West Greece","West Macedonia","Ionian Islands ","Epirus ","Central Macedonia","Crete","South Aegean","Peloponnese ","Central Greece ","Thessaly","North Aegean")

caves_Region$regions <- greece_regions
species_Region$regions <- greece_regions

```

```{r,warning=FALSE, message=FALSE, echo=FALSE}
# Transform to dataframe
# https://www.r-bloggers.com/using-r-working-with-geospatial-data-and-ggplot2/

greece_level_2@data$id <- rownames(greece_level_2@data)

watershedPoints <- fortify(greece_level_2, region = "id")

watershedDF <- merge(watershedPoints, greece_level_2@data, by = "id")

watershedDF <- watershedDF %>% left_join(., caves_Region, by=c("NAME_2"="regions")) %>% left_join(., species_Region, by=c("NAME_2"="regions"))

cnames <- aggregate(cbind(long, lat) ~ NAME_2, data=watershedDF, FUN=function(x)mean(range(x))) %>% left_join(., caves_Region, by=c("NAME_2"="regions"))

cnames_species <- aggregate(cbind(long, lat) ~ NAME_2, data=watershedDF, FUN=function(x)mean(range(x))) %>% left_join(., species_Region, by=c("NAME_2"="regions"))

```


Caves distribution across all regions in Greece.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}
library(wesanderson)


ggWatershed <- ggplot(data = watershedDF,aes(x=long, y=lat)) +
  geom_polygon(data = watershedDF,aes(x=long, y=lat,group = group,fill = number_of_caves),color="white",lwd=0.2) +
  #geom_path(size= 0.2,color = "white") +
  #coord_equal() +
  #geom_text(data=cnames,aes(label = number_of_caves, x = long, y = lat)) + 
  scale_fill_gradient(low="blue", high="red",breaks=seq(0,200,50), limits=c(0,200),name="Caves")+
  theme_bw()+
  theme(panel.border = element_blank(),panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank())

ggsave("caves_spatial_dist_per_region_no_text.jpeg", plot = ggWatershed, device = "jpeg", dpi = 300,path = "Plots/")


```

![Samplings from caves in Greece.](Plots/caves_spatial_dist_per_region_no_text.jpeg)

Species distribution across all regions in Greece.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}

ggWatershed <- ggplot(data = watershedDF,aes(x=long, y=lat)) +
  geom_polygon(data = watershedDF,aes(x=long, y=lat,group = group,fill = number_of_species),color="white",lwd=0.2) +
  #geom_path(size= 0.2,color = "white") +
  #coord_equal() +
  #geom_text(data=cnames_species,aes(label = number_of_species, x = long, y = lat)) + 
  scale_fill_gradient(low="grey", high="red",breaks=seq(0,300,50), limits=c(0,300),name="Species")+
  theme_bw()+
  theme(panel.border = element_blank(),panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank())

ggsave("species_spatial_dist_per_region_no_text.jpeg", plot = ggWatershed, device = "jpeg", dpi = 300,path = "Plots/")
```

![Cave fauna distribution in Greece.](Plots/species_spatial_dist_per_region_no_text.jpeg)


## Species and caves distribution across Greek municipalities


```{r,warning=FALSE, message=FALSE, echo=FALSE,eval=TRUE}
# Transform to dataframe
# https://www.r-bloggers.com/using-r-working-with-geospatial-data-and-ggplot2/

municipalities_shape_file_dataframe <- tidy(municipalities_shape_file)

municipalities_greece_long_names_eng$id <- as.character(seq(from=0, to=(nrow(municipalities_greece_long_names_eng)-1)))

watershedDF <- municipalities_shape_file_dataframe %>% left_join(., municipalities_greece_long_names_eng, by=c("id"="id")) %>% left_join(., caves_species_municipality_join, by=("Municipalities_ISO_843"="Municipalities_ISO_843"))

cnames <- aggregate(cbind(long, lat) ~ Municipalities_ISO_843, data=watershedDF, FUN=function(x)mean(range(x))) %>% left_join(., caves_species_municipality_join, by=c("Municipalities_ISO_843"="Municipalities_ISO_843"))

cnames_species <- aggregate(cbind(long, lat) ~ Municipalities_ISO_843, data=watershedDF, FUN=function(x)mean(range(x))) %>% left_join(., caves_species_municipality_join, by=c("Municipalities_ISO_843"="Municipalities_ISO_843"))

watershedDF$number_of_caves[is.na(watershedDF$number_of_caves)] <- 0
watershedDF$number_of_species[is.na(watershedDF$number_of_species)] <- 0

```


```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}
library(wesanderson)


ggWatershed <- ggplot(data = watershedDF,aes(x=long, y=lat)) +
  geom_polygon(data = watershedDF,aes(x=long, y=lat,group = group,fill = number_of_caves),color="white",lwd=0.08) +
  #geom_path(size= 0.2,color = "white") +
  #coord_equal() +
  #geom_text(data=cnames,aes(label = number_of_caves, x = long, y = lat)) + 
  scale_fill_gradient(low="blue", high="red",breaks=seq(0,20,5), limits=c(0,20),name="Caves")+
  theme_bw()+
  theme(panel.border = element_blank(),panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank())

ggsave("caves_spatial_dist_per_municipality_no_text.jpeg", plot = ggWatershed, device = "jpeg", dpi = 300,path = "Plots/")


```

![Caves that have been sampled in Greece](Plots/caves_spatial_dist_per_municipality_no_text.jpeg)


```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}

ggWatershed <- ggplot(data = watershedDF,aes(x=long, y=lat)) +
  geom_polygon(data = watershedDF,aes(x=long, y=lat,group = group,fill = number_of_species),color="white",lwd=0.082) +
  #geom_path(size= 0.2,color = "white") +
  #coord_equal() +
  #geom_text(data=cnames,aes(label = number_of_caves, x = long, y = lat)) + 
  scale_fill_gradient(low="grey", high="red",breaks=seq(0,80,20), limits=c(0,80),name="Species")+
  theme_bw()+
  theme(panel.border = element_blank(),panel.grid.minor = element_blank(), panel.grid.major = element_blank(),axis.title = element_blank(), axis.text = element_blank(),axis.ticks = element_blank())

ggsave("species_spatial_dist_per_municipality_no_text.jpeg", plot = ggWatershed, device = "jpeg", dpi = 300,path = "Plots/")


```

![Species sampled per municipality in Greece](Plots/species_spatial_dist_per_municipality_no_text.jpeg)

## Greece caves and protected areas

```{r, warning=FALSE, message=FALSE, echo=FALSE}
caves_in_SCI <- species_occurencies_unique_caves_all_info %>% filter(SITETYPE_NATURA=="SCI") %>% nrow()
caves_in_SPA <- species_occurencies_unique_caves_all_info %>% filter(SITETYPE_NATURA=="SPA") %>% nrow()
caves_in_SCISPA <- species_occurencies_unique_caves_all_info %>% filter(SITETYPE_NATURA=="SPASCI") %>% nrow()
caves_in_KAZ <- species_occurencies_unique_caves_all_info %>% filter(!is.na(KODE))%>% nrow()


caves_in_areas <- data.frame(Areas=c("NATURA2000 SCI","NATURA2000 SPA", "NATURA2000 SPASCI", "Wildlife Refugee"), Caves=c(caves_in_SCI,caves_in_SPA,caves_in_SCISPA,caves_in_KAZ))

caves_in_areas_caption <- "Number of caves per protected area type"
kable(caves_in_areas,caption=caves_in_areas_caption, align = 'l')

```


With google earth background.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}
## load greek borders

hellenic_borders_shapefile <- maptools::readShapeLines("hellenic_borders/hellenic_borders",verbose=TRUE)

proj4string(hellenic_borders_shapefile) <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")  # this is WGS84

hellenic_borders_shapefile_dataframe <- tidy(hellenic_borders_shapefile)
bbox_hellenic_borders <- hellenic_borders_shapefile@bbox
bbox_hellenic_borders_lat <- bbox_hellenic_borders

## get map
map_greece <- get_map(location = c(lon=mean(bbox_hellenic_borders[1,]), lat=mean(bbox_hellenic_borders[2,])),zoom = 6,maptype = "terrain")

# plot map

map_greece_plot <- ggmap(map_greece)+
  geom_polygon(data = natura2000shapefile_dataframe,aes(x=long, y=lat,group = group,fill="Natura2000"),lwd=0.082, alpha=0.6)+
  geom_polygon(data = katafygia_agrias_zwhs_dataframe,aes(x=long, y=lat,group = group,fill="Wildlife Refuge"),lwd=0.082,alpha=0.8)+
  geom_point(data = species_occurencies_unique_caves_all_info,aes(x=Longitude, y=Latitude,color="Caves"),size = 0.2)+
  labs(x="Longitude",y="Latitude")+
  scale_fill_manual(values = c("Natura2000"="chartreuse3","Wildlife Refuge"="chocolate2"),name="Protected areas")+
  scale_color_manual(name="", values = c("Caves"="red"))+
  scale_x_continuous(breaks = seq(20,30,2),limits = c(20,30))+
  scale_y_continuous(breaks = seq(35,42,2),limits = c(34.5,42))+
  coord_map(xlim = c(19,30.1), ylim = c(34.5,42))+
  theme_bw()
#geom_text(data = sisquoc, aes(label = paste("  ", as.character(name), sep="")), angle = 60, hjust = 0, color = "yellow")
    
ggsave("map_greece_plot_protected_areas.jpeg", plot = map_greece_plot, device = "jpeg", dpi = 300,path = "Plots/")

```
![Caves and protected areas in Greece](Plots/map_greece_plot_protected_areas.jpeg)

Only with borders.

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}



map_greece_plot_lines <- ggplot()+
  geom_polygon(data = natura2000_NEW_shapefile_dataframe,aes(x=long, y=lat,group = group,fill=SITE_TYPE),lwd=0.082, alpha=0.6)+
  geom_polygon(data = hellenic_borders_shapefile_dataframe,aes(x=long, y=lat,group = group),lwd=0.12,color="black")+
  geom_polygon(data = natura2000shapefile_dataframe,aes(x=long, y=lat,group = group,fill=SITETYPE),lwd=0.082, alpha=0.6)+
  geom_polygon(data = katafygia_agrias_zwhs_dataframe,aes(x=long, y=lat,group = group,fill="Wildlife Refuge"),lwd=0.082,alpha=0.8)+
  geom_point(data = species_occurencies_unique_caves,aes(x=Longitude, y=Latitude,color="Caves"),size = 0.2)+
  labs(x="Longitude",y="Latitude")+
  #scale_fill_manual(values = c("chartreuse3","purple","cyan3","chocolate2"),labels = c("Natura2000 SCI", "Natura2000 SPA", "Natura2000 SPASCI","Wildlife Refuge"),name="Protected areas")+
  #scale_fill_manual(values = c("SCI"="chartreuse3","SPA"="purple","SPASCI"="cyan3", "Wildlife Refuge"="chocolate2"),labels = c("Natura2000 SCI", "Natura2000 SPA", "Natura2000 SPASCI","Wildlife Refuge")name="Protected areas")+
  scale_color_manual(name="", values = c("Caves"="red"))+
  scale_x_continuous(breaks = seq(20,30,1),limits = c(20,30))+
  scale_y_continuous(breaks = seq(35,42,1),limits = c(34.5,42))+
  coord_map(xlim = c(19,30.1), ylim = c(34.5,42))+
  theme_bw()+
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),legend.position = c(0.87, 0.75),legend.text = element_text(size=9),legend.title = element_text(size=10))
#geom_text(data = sisquoc, aes(label = paste("  ", as.character(name), sep="")), angle = 60, hjust = 0, color = "yellow")
    
ggsave("map_greece_plot_lines.jpeg", plot = map_greece_plot_lines, device = "jpeg", dpi = 300,path = "Plots/")


```

![Caves and protected areas in Greece (only borders)](Plots/map_greece_plot_lines.jpeg)

## Macedonia caves and protected areas

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE,cache=TRUE}
# plot map

location_alistrati <- c(lon=23.9663,lat=41.0508)

map_makedonia <- get_map(location = location_alistrati,zoom = 10,maptype="terrain")

map_makedonia_NATURA_dataframe <- natura2000shapefile_dataframe %>% filter(., CODE=="GR1260009")

map_makedonia_katafygia_agrias_zwhs_dataframe <- katafygia_agrias_zwhs_dataframe %>% filter(.,area=="5688567")

map_makedonia_plot <- ggmap(map_makedonia)+
  geom_polygon(data = map_makedonia_NATURA_dataframe,aes(x=long, y=lat,group = group,fill=CODE),lwd=0.082, alpha=0.8)+
  geom_polygon(data = map_makedonia_katafygia_agrias_zwhs_dataframe,aes(x=long, y=lat,group = group,fill=area),lwd=0.082, alpha=0.8)
  
ggsave("caves_protected_areas_Macedonia.jpeg", plot = map_makedonia_plot, device = "jpeg", dpi = 300,path = "Plots/")

```
![Caves and protected areas in Mecedonia region](Plots/caves_protected_areas_Macedonia.jpeg)


# What's next

1. Assign to each cave the respective description and exploration references from literature

Done: `r sum(!is.na(unique(species_occurencies$CaveReferences)))`

Missing: `r nrow(species_occurencies_unique_caves)-sum(!is.na(unique(species_occurencies$CaveReferences)))`

2. Locate all caves

Done: `r species_occurencies_unique_caves %>% dplyr::select(Latitude) %>% filter(!(is.na(Latitude))) %>% nrow()`

Missing: `r species_occurencies_unique_caves %>% dplyr::select(Latitude) %>% filter(is.na(Latitude)) %>% nrow()`

3. Find the distributions of species

Done: `r species_occurencies %>% distinct(Species,Distribution_IUCN) %>% filter(!is.na(Distribution_IUCN)) %>% nrow()`

Missing: `r species_occurencies %>% distinct(Species,Distribution_IUCN) %>% filter(is.na(Distribution_IUCN)) %>% nrow()`

4. Species type regarding troglofauna characterisation

Done:`r species_occurencies %>% distinct(Species,Troglofauna_characterisation) %>% filter(!is.na(Troglofauna_characterisation)) %>% nrow()`

Missing: `r species_occurencies %>% distinct(Species,Troglofauna_characterisation) %>% filter(is.na(Troglofauna_characterisation)) %>% nrow()`

5. Complete the list of species hyperinks with other databases

`r species_links_summary_caption <- "Links to different databases for individual species"
kable(species_links_summary,caption=species_links_summary_caption, align = 'l')`


In the case of IUCN database there are missing links because these species are not included in the databese. This has to be clarified for the rest databases.


```{r setup, include=FALSE,warning=FALSE, message=FALSE,eval=FALSE}


jabref_caves <- read_csv(file = "Cave_Fauna_References28_08_2017.csv",col_names = T)

jabref_caves <- jabref_caves %>% select(Identifier,Author,Title,Journal,Volume,Number,Pages,Year,Booktitle,Chapter,Edition,Editor,Publisher,Custom3)

colnames(jabref_caves) <- c("Identifier","Author","Title","Journal","Volume","Number","Pages","Year","Booktitle","Chapter","Edition","Editor","Publisher","Keywords")

#write_delim(jabref_caves,path = "/Users/savasp/Dropbox/Ινστιτούτο Σπηλαιολογικών Ερευνών Ελλάδας/Conservation of the cave fauna of Greece - MAVA/Cave_Fauna_database/Cave_Fauna_References_28_08_2017_fromR.tsv",delim = "\t")

id <- jabref_caves %>% group_by(Identifier) %>% summarise(n=n())


```

```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

#### Not RUN

#from csv that RafJeb exported! Problems with the year.. 

species_references <- read_csv(file = "Cave_Fauna_References28_08_2017.csv",col_names = TRUE)

#species_references1 <- species_references %>% mutate(n_authors=)
species_references$n_authors <- str_count(species_references$Author, pattern = ";") +str_count(species_references$Author, pattern = "&") +1

species_references$first_author <- gsub("^(.*?),.*", "\\1", species_references$Author)

species_references$second_author <- gsub(pattern = ".*& (.+?),.*",replacement = "\\1",species_references$Author)  #"; *([^.,]*)"

species_references$Pages_first <- gsub("^(.*?)--.*", "\\1", species_references$Pages)

species_references$Pages_last <- sub('.*\\--', '', species_references$Pages) 

species_references$Pages <- with(species_references, ifelse(Pages_first==Pages_last,paste0(Pages_first),paste0(Pages_first,"-",Pages_last)))

species_references$short_reference <- with(species_references,ifelse(n_authors==1,paste0(first_author," ",Year),ifelse(n_authors==2,paste0(first_author," & ",second_author," ",Year),paste0(first_author," et al. ",Year))))

species_references_ready <- species_references %>% group_by(short_reference) %>% mutate(n_dupl_citation=n()) %>% mutate(short_reference_ready=if_else(n_dupl_citation==1,paste0(short_reference),paste0(short_reference,letters[1:n_dupl_citation]))) %>% ungroup(short_reference) %>% dplyr::select(-Author, -short_reference,-second_author,-Pages_last,-Pages_first,-n_authors,-first_author,-second_author,-n_dupl_citation,-BibliographyType,-ISBN,-Custom5,-Custom4)


## Initials of Authors 

species_references_author <- strsplit(x = as.character(species_references$Author), "[;&]")

species_references_author_spreaded <- data.frame(Identifier = rep.int(species_references$Identifier,sapply(species_references_author, length)),Author = rep.int(species_references$Author,sapply(species_references_author, length)), Author_spread = gsub("^\\s|\\s$", "",unlist(species_references_author))) 


Last_names <- gsub(",.*", "\\1", species_references_author_spreaded$Author_spread,perl = TRUE)

sort_names_initials <- iconv(gsub("[:a-z:]|\\s|\\.|[[:punct:]]", "", gsub(".*,", "\\1", species_references_author_spreaded$Author_spread,perl = TRUE)), "UTF-8", "ASCII", sub = "")
 #\\B\\w

sort_names_initials_ready <- trimws(gsub("([A-Z])", "\\1. ", sort_names_initials),which = "right")

species_references_author_spreaded$Author_spread_Initials <- paste0(Last_names,", ",sort_names_initials_ready)
species_references_author <- species_references_author_spreaded %>% group_by(Identifier) %>% summarise(Author=paste0(Author_spread_Initials,collapse="; ")) %>% mutate(Author=gsub(";",",",gsub("(.*)\\;(.*)", "\\1 &\\2",Author)))


##References ready for import to database

species_references_ready <- species_references_ready %>% left_join(., species_references_author, by=c("Identifier"="Identifier"))

```


```{r,warning=FALSE, message=FALSE, echo=FALSE,eval=FALSE}
#Read XML.


library(XML)



xmlfile <- xmlParse("My CollectionXML.xml")
# the xml file is now saved as an object you can easily work with in R:
class(xmlfile)


xmltop <- xmlRoot(xmlfile) #gives content of root
class(xmltop)#"XMLInternalElementNode" "XMLInternalNode" "XMLAbstractNode"
xmlName(xmltop) #give name of node, PubmedArticleSet
xmlSize(xmltop) #how many children in node, 19
xmlName(xmltop[[1]]) #name of root's children


data <- xmlSApply(xmltop,function(x) xmlSApply(x, xmlValue))

cd.catalog <- data.frame(t(data),row.names=NULL)

```

```{r,  warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}

## RUN because here there are the names of municipalities

########### Municipalities data from csv. It was unsuccessfull. ############## Some polygons were missing area. Maybe some of the transformations broke them.

municipalities_greece <- read_csv(file = "municipalities_shape_file/municipalities_Kallikratis_plan_Greece.csv",col_names = T) %>% dplyr::select(NAME,the_geom,KWD_YPES)

#municipalities_greece$the_geom0 <- gsub(" ",";",municipalities_greece$the_geom)

municipalities_greece$the_geom2 <- gsub("[MULTIPOLYGON()]","",municipalities_greece$the_geom)

#municipalities_greece$the_geom3 <- gsub(")))","",municipalities_greece$the_geom2)


municipalities_greece_str <- strsplit(x = as.character(municipalities_greece$the_geom2), ",")

municipalities_greece_long <- data.frame(Municipality = rep.int(municipalities_greece$NAME, sapply(municipalities_greece_str, length)),KWD_YPES = rep.int(municipalities_greece$KWD_YPES, sapply(municipalities_greece_str, length)), Reference_spread = unlist(municipalities_greece_str))

municipalities_greece_long$Latitude <- as.character(lapply(strsplit(as.character(municipalities_greece_long$Reference_spread), split=" "), "[", n=2))

municipalities_greece_long$Longtitude <- as.character(lapply(strsplit(as.character(municipalities_greece_long$Reference_spread), split=" "), "[", n=3))

municipalities_greece_long_names <- municipalities_greece_long %>% dplyr::select(Municipality,KWD_YPES) %>% distinct()

municipalities_greece_long_names_eng <- read_xlsx("municipalities_shape_file/names_municipalities_gr_eng.xlsx",col_names = T)

municipalities_greece_long_names_combined <- cbind(municipalities_greece_long_names,municipalities_greece_long_names_eng) 

colnames(municipalities_greece_long_names_combined) <- c("Municipality","KWD_YPES","Municipalities_ISO_843")
# fileConn<-file("municipalities_greece_long_names.txt")
# writeLines(as.character(municipalities_greece_long_names$Municipality), fileConn)
# close(fileConn)

municipalities_greece_long_names_combined$KWD_YPES <- as.factor(municipalities_greece_long_names_combined$KWD_YPES)

# Get data ready to import to Spatial Polygon

municipalities_greece_long$Latitude <- as.numeric(municipalities_greece_long$Latitude)
municipalities_greece_long$Longtitude <- as.numeric(municipalities_greece_long$Longtitude)

municipalities_greece_long_2 <- municipalities_greece_long %>% dplyr::select(Latitude,Longtitude)

#Transform dataframe to list

municipalities_greece_long_list <- split(municipalities_greece_long_2, municipalities_greece_long$Municipality)
# only want lon-lats in the list, not the names
municipalities_greece_long_list <- lapply(municipalities_greece_long_list, function(x) { x["Municipality"] <- NULL; x })

ps <- lapply(municipalities_greece_long_list, Polygon)


# add id variable
p1 <- lapply(seq_along(ps), function(i) Polygons(list(ps[[i]]), 
                                            ID = names(municipalities_greece_long_list)[i]))


# create SpatialPolygons object
EPSG4326<-CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

my_spatial_polys <- SpatialPolygons(p1, proj4string = EPSG4326 )


```


```{r, warning=FALSE, message=FALSE, echo=FALSE, eval=FALSE}
#example
#http://data-analytics.net/cep/Schedule_files/geospatial.html


data(crime)
plot(crime$lon,crime$lat,xlab="lon",ylab="lat")

HoustonMap<-qmap("houston", zoom = 14)  #First, get a map of Houston

HoustonMap+                                        ##This plots the Houston Map
geom_point(aes(x = lon, y = lat), data = crime)


houston <- get_map(location = "houston", zoom = 13) ##Get the houston map
houstonMap<-ggmap(houston, extent = "device")       ##Prepare Map

houstonMap +
  stat_density2d(aes(x = lon, y = lat, fill = ..level..,alpha=..level..), bins = 10, geom = "polygon", data = crime) +
  scale_fill_gradient(low = "black", high = "red")+
  ggtitle("Map of Crime Density in Houston")
```


# References
